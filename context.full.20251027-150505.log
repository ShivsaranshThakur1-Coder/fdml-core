=== FULL CONTEXT HARVEST ===
CWD: /Users/shivsaranshthakur/Projects/fdml-core
When: 2025-10-27T15:05:05+00:00

## System
Darwin Shivsaranshs-MacBook-Pro.local 23.3.0 Darwin Kernel Version 23.3.0: Wed Dec 20 21:30:59 PST 2023; root:xnu-10002.81.5~7/RELEASE_ARM64_T6030 arm64
ProductName:		macOS
ProductVersion:		14.3
BuildVersion:		23D56

## Git — branches, remotes, status, recent commits
git version 2.39.3 (Apple Git-146)
/Users/shivsaranshthakur/Projects/fdml-core
origin	git@github.com:ShivsaranshThakur1-Coder/fdml-core.git (fetch)
origin	git@github.com:ShivsaranshThakur1-Coder/fdml-core.git (push)
## main...origin/main
 M dependency-reduced-pom.xml
 M site/cards/example-01.fdml.html
 M site/cards/example-02.fdml.html
 M site/cards/example-03.fdml.html
 M site/cards/example-04.fdml.html
 M site/cards/example-05-contra.fdml.html
 M site/cards/example-06-square.fdml.html
 M site/cards/example-07-mixer.fdml.html
 M site/cards/example-08-init.fdml.html
 D site/cards/style.css
 M site/index.html
?? context.20251027-144617.log
?? context.deep.20251027-145328.log
?? context.full.20251027-150505.log
?? docs/progress-report/week05_progress.aux
?? docs/progress-report/week05_progress.fdb_latexmk
?? docs/progress-report/week05_progress.fls
?? docs/progress-report/week05_progress.log
?? docs/progress-report/week05_progress.out
?? docs/progress-report/week05_progress.pdf
* main 74dcc31 [origin/main] docs(progress): add Week 5 LaTeX progress report and README
-- last 40 commits --
* 74dcc31 (HEAD -> main, origin/main, origin/HEAD) docs(progress): add Week 5 LaTeX progress report and README
* e2816f0 xsl: card pages link ../style.css (single stylesheet at site root)
* 28af9e8 site: reset XSL, rebuild cards with css v=1761573613, include cards/style.css
* 19d82a9 pages: rebuild site (css v=1761573203) and include site/cards/style.css
* c5ecb19 xsl: add cssVersion param + dynamic cssHref and link
* 8975994 pages: ship cards/style.css and rebuild with CSSV=1761571994
* 57b1d09 pages: ensure cards/style.css present; rebuild with CSSV=1761571152
* 794fde0 pages: rebuild with CSSV=1761570830
* 2eba03c Normalize output: cards only under site/cards, fix back/index links and stylesheet location
* 8be182a ui: rebuild site with polished theme & cards grid (v1761070729)
* 002d2a5 ui: professional theme refresh (1761070240)
* 4452f91 ui: fix XSL, pro index, cache-busted CSS (1761069182)
* 11f01da ui: pro theme, nav/hero/grid, cache-busted CSS (1761068934), consistent back-links
* 349c073 pages: pass cssVersion into XSLT (CSSV) and use run_id for cache-busting
* aee9617 pages: cssVersion=1761063795 via XSLT param; rebuild site with same cb
* e062b9b pages: rebuild site with cssVersion=1761063091 and ship style.css to / and /cards
* 50c32fa ui: add sticky header/nav, improved typography, tables, dark+light theme; dynamic CSS cache-busting
* f80548d deploy: republish site with latest CSS
* a8ec1eb ui: professional theme (light/dark), container layout, polished cards/tables
* 0e0be7a chore: remove embedded repo and ignore it
* 51794e4 style: apply richer CSS + cache-busted stylesheet link for cards
* ba3f81b style: apply restored rich CSS and cache-busted link in XSLT
* 0a518c8 style: restore rich CSS from pre-externalization commit
* 53c8205 style: restore richer CSS extracted from earlier inline XSLT
* 7c85411 render: link external style.css from XSLT; upgrade shared styling
* 1ea104c cards: drop inline CSS from XSLT; link external style.css
* c676104 site: fix build_index.sh, stop calling missing script, publish site/ with style.css
* 73c39e7 site: add docs/style.css; build site/; publish site/ via cards-pages; remove conflicting pages.yml
* 5b6929f ci(cards): publish fdml-core site/ (styled) to /fdml-core
* 076d557 build: copy style.css to site root and /cards; generate index with links to root and /cards
* 7ac7438 ci(pages): publish docs at / and cards under /cards
* cc0e38b site: absolute links with cache-busting param
* 45d92a4 site: make index links absolute to /fdml-core/
* ee55afe docs(core): link to live HTML cards (GitHub Pages)
* 090ba8a ci(pages): generate index.html for site root
* 72d0cb7 site: add index.html listing all card pages
* 7c89deb (tag: v0.3.3-demo) ci(pages): publish HTML cards to GitHub Pages
* add610d docs(core): add render-test CI badge
* 11d3a18 ci(render): upload HTML cards as artifact
* 5914619 ci(render): build HTML cards with xsltproc on push/PR

## File inventory (depth<=3; heavy dirs pruned)
.
.editorconfig
.github
.github/workflows
.github/workflows/cards-pages.yml
.github/workflows/ci.yml
.github/workflows/fdml-validate.yml
.github/workflows/release.yml
.github/workflows/render-test.yml
.gitignore
CHANGELOG.md
LICENSE
LICENSE-DATA
Makefile
README.md
bin
bin/fdml
context.20251027-144617.log
context.deep.20251027-145328.log
context.full.20251027-150505.log
corpus
corpus/invalid
corpus/invalid/example-01-invalid.fdml.xml
corpus/invalid/example-02-empty-title.fdml.xml
corpus/invalid/example-03-dup-id.fdml.xml
corpus/invalid/example-04-bad-email.fdml.xml
corpus/invalid/example-05-missing-id.fdml.xml
corpus/invalid/example-06-bad-figure.fdml.xml
corpus/invalid/example-07-bad-use.fdml.xml
corpus/valid
corpus/valid/example-01.fdml.xml
corpus/valid/example-02.fdml.xml
corpus/valid/example-03.fdml.xml
corpus/valid/example-04.fdml.xml
corpus/valid/example-05-contra.fdml.xml
corpus/valid/example-06-square.fdml.xml
corpus/valid/example-07-mixer.fdml.xml
corpus/valid/example-08-init.fdml.xml
css
css/print.css
dependency-reduced-pom.xml
docs
docs/ARCHITECTURE.md
docs/CONTRIBUTING.md
docs/USAGE.html
docs/USAGE.md
docs/css
docs/css/print.css
docs/examples
docs/examples/example-01.fdml.html
docs/examples/example-02.fdml.html
docs/examples/example-03.fdml.html
docs/examples/example-04.fdml.html
docs/examples/example-05-contra.fdml.html
docs/examples/example-06-square.fdml.html
docs/examples/example-07-mixer.fdml.html
docs/examples/example-08-init.fdml.html
docs/examples/index.html
docs/index.html
docs/pdfs
docs/pdfs/example-01.fdml.pdf
docs/pdfs/example-02.fdml.pdf
docs/pdfs/example-03.fdml.pdf
docs/pdfs/example-04.fdml.pdf
docs/pdfs/example-05-contra.fdml.pdf
docs/pdfs/example-06-square.fdml.pdf
docs/pdfs/example-07-mixer.fdml.pdf
docs/pdfs/example-08-init.fdml.pdf
docs/progress-report
docs/progress-report/README.md
docs/progress-report/week05_progress.aux
docs/progress-report/week05_progress.fdb_latexmk
docs/progress-report/week05_progress.fls
docs/progress-report/week05_progress.log
docs/progress-report/week05_progress.out
docs/progress-report/week05_progress.pdf
docs/progress-report/week05_progress.tex
docs/site.css
docs/style.css
homebrew-fdml
homebrew-fdml/.git
homebrew-fdml/.git/COMMIT_EDITMSG
homebrew-fdml/.git/HEAD
homebrew-fdml/.git/config
homebrew-fdml/.git/description
homebrew-fdml/.git/hooks
homebrew-fdml/.git/index
homebrew-fdml/.git/info
homebrew-fdml/.git/logs
homebrew-fdml/.git/objects
homebrew-fdml/.git/refs
homebrew-fdml/Formula
homebrew-fdml/Formula/fdml.rb
homebrew-fdml/fdml-core-0.3.0.jar
pom.xml
schema
schema/fdml.xsd
schematron
schematron/fdml-compiled.xsl
schematron/fdml.sch
scripts
scripts/build_index.sh
scripts/ci_debug.sh
scripts/ci_diff.sh
scripts/ci_latest.sh
scripts/ci_logs.sh
scripts/gen_examples.sh
scripts/local_sanity.sh
site
site/index.html
site/style.css
src
src/main
src/main/java
src/test
src/test/java
src/test/resources
test
test/e2e
test/perf
test/snapshot
test/unit
xslt
xslt/card.xsl
xslt/fdml-to-card.xsl
xslt/fdml-to-xhtml.xsl
xslt/style.css

## Toolchain
openjdk version "17.0.16" 2025-07-15
Apache Maven 3.9.11 (3e54c93a704957b63ee3494413a2b544fd3d825b)
Maven home: /opt/homebrew/Cellar/maven/3.9.11/libexec
Java version: 17.0.16, vendor: Homebrew, runtime: /opt/homebrew/Cellar/openjdk@17/17.0.16/libexec/openjdk.jdk/Contents/Home
v20.18.0
10.8.2
Using libxml 20913, libxslt 10135 and libexslt 820
Latexmk, John Collins, 31 Jan. 2024. Version 4.83

## Core configs & docs (full text)
--- BEGIN README.md ---
[![render-test](https://github.com/ShivsaranshThakur1-Coder/fdml-core/actions/workflows/render-test.yml/badge.svg?branch=main)](https://github.com/ShivsaranshThakur1-Coder/fdml-core/actions/workflows/render-test.yml)

[![fdml-validate](https://github.com/ShivsaranshThakur1-Coder/fdml-core/actions/workflows/fdml-validate.yml/badge.svg?branch=main)](https://github.com/ShivsaranshThakur1-Coder/fdml-core/actions/workflows/fdml-validate.yml)

# FDML Core

Implementation of the FDML project: schema + validation (XSD + Schematron), transforms (XSLT), sample corpus, and test/CI scaffolding.

## Layout
- `schema/` — FDML XSD schema
- `schematron/` — business-rule validation
- `xslt/` — transformations (HTML card renderer, etc.)
- `css/` — stylesheets for rendered output
- `corpus/valid` and `corpus/invalid` — example FDML documents
- `docs/` — architecture/spec notes
- `test/` — unit, snapshot, e2e, perf scaffolding
- `.github/workflows/` — CI

## Getting Started
- Java 17 required (installed in Step 1).
- CI currently runs a placeholder `make ci`. Validation/build steps will be added in Step 3+.

## Licenses
- Code: MIT (`LICENSE`)
- Docs & corpus: CC BY 4.0 (`LICENSE-DATA`)

## Quick CLI

Build once:
```bash
mvn -q -DskipTests package
## Install (Homebrew)

~~~bash
brew tap ShivsaranshThakur1-Coder/fdml
brew install fdml
~~~

## Quick Start

```bash
fdml init song.fdml.xml --title "My Dance" --meter 3/4 --tempo 96 --figure-id f-1 --figure-name Intro
fdml validate song.fdml.xml
fdml validate corpus/valid/*.xml
fdml validate song.fdml.xml --json --json-out result.json
```

## Local CI

```bash
make ci
```

## Render

```bash
make html
open out/html/example-01.fdml.html
```

**Live cards:** https://shivsaranshthakur1-coder.github.io/fdml-core/

--- END README.md ---
--- BEGIN CHANGELOG.md ---
# Changelog

## v0.3.3 — Tap-ready Homebrew release
- Homebrew formula and CI pipelines finalized (tap-test, tap-audit).
- CLI wrapper path-resolution improvements.
- Schema and Schematron pinned and published as release assets.
- Docs PDFs refreshed and install instructions added.

## v0.3.0 — Initial public CLI
- Initial `fdml` JAR + `validate` / `init` commands.
- Basic schema and schematron validation.

--- END CHANGELOG.md ---
--- BEGIN Makefile ---
.PHONY: html validate-valid validate-invalid json ci clean

html:
	@set -e; TS=$$(date +%s); out=out/html; mkdir -p $$out; tmp=$$(mktemp); \
		find corpus/valid -type f -name '*.xml' | sort > $$tmp; \
		while IFS= read -r f; do \
			base=$$(basename "$$f"); stem=$${base%.xml}; \
			echo "HTML  $$out/$$stem.html"; \
			xsltproc --stringparam cssVersion $$TS xslt/card.xsl "$$f" > "$$out/$$stem.html"; \
		done < $$tmp; rm -f $$tmp; \
		mkdir -p site; cp -f docs/style.css site/style.css; cp -f $$out/*.html site/; \
		scripts/build_index.sh $$TS

validate-valid:
	@set -e; tmp=$$(mktemp); find corpus/valid -type f -name '*.xml' | sort > $$tmp; \
		while IFS= read -r f; do echo "VALID  $$f"; fdml validate "$$f"; done; rm -f $$tmp

validate-invalid:
	@set -e; tmp=$$(mktemp); find corpus/invalid -type f -name '*.xml' | sort > $$tmp; failures=0; \
		while IFS= read -r f; do echo "INVALID $$f"; if fdml validate "$$f"; then echo "EXPECTED FAILURE but got success: $$f"; failures=$$((failures+1)); fi; done; \
		rm -f $$tmp; test $$failures -eq 0

json:
	@set -e; out=out/json; mkdir -p $$out; tmp=$$(mktemp); \
		find corpus/valid -type f -name '*.xml' | sort > $$tmp; \
		while IFS= read -r f; do base=$$(basename "$$f"); stem=$${base%.xml}; \
			echo "JSON  $$out/$$stem.json"; fdml validate "$$f" --json --json-out "$$out/$$stem.json"; \
		done < $$tmp; rm -f $$tmp

ci: validate-valid validate-invalid html

clean:
	rm -rf out site

--- END Makefile ---
--- BEGIN pom.xml ---
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>org.fdml</groupId>
  <artifactId>fdml-core</artifactId>
  <version>0.2.0-SNAPSHOT</version>
  <properties>
    <maven.compiler.release>17</maven.compiler.release>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  </properties>

  <dependencies>
    <dependency>
      <groupId>net.sf.saxon</groupId>
      <artifactId>Saxon-HE</artifactId>
      <version>12.4</version>
    </dependency>
    <dependency>
      <groupId>org.junit.jupiter</groupId>
      <artifactId>junit-jupiter</artifactId>
      <version>5.10.2</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>com.openhtmltopdf</groupId>
      <artifactId>openhtmltopdf-pdfbox</artifactId>
      <version>1.0.10</version>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.11.0</version>
        <configuration><release>17</release></configuration>
      </plugin>

      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-shade-plugin</artifactId>
        <version>3.5.0</version>
        <executions>
          <execution>
            <phase>package</phase>
            <goals><goal>shade</goal></goals>
            <configuration>
              <finalName>fdml-core</finalName>
              <filters>
                <filter>
                  <artifact>*:*</artifact>
                  <excludes>
                    <exclude>META-INF/*.SF</exclude>
                    <exclude>META-INF/*.DSA</exclude>
                    <exclude>META-INF/*.RSA</exclude>
                  </excludes>
                </filter>
              </filters>
              <transformers>
                <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                  <mainClass>org.fdml.cli.Main</mainClass>
                </transformer>
              </transformers>
            </configuration>
          </execution>
        </executions>
      </plugin>

      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.2.5</version>
      </plugin>
    </plugins>
  </build>
</project>

--- END pom.xml ---
--- BEGIN .editorconfig ---
root = true

[*]
end_of_line = lf
insert_final_newline = true
charset = utf-8
indent_style = space
indent_size = 2

--- END .editorconfig ---
--- BEGIN .gitignore ---
# macOS
.DS_Store

# Editors
.vscode/
.idea/

# Node
node_modules/

# Java/Maven/Gradle (future steps)
target/
.build/
.gradle/

# Build output
out/
homebrew-fdml/

--- END .gitignore ---
--- BEGIN docs/ARCHITECTURE.md ---
# Architecture (initial)

- XSD defines core structure.
- Schematron adds business-rule validation.
- XSLT renders to HTML (card-style).
- CLI + CI to be wired in next steps.

--- END docs/ARCHITECTURE.md ---
--- BEGIN docs/USAGE.md ---
# FDML — Usage

## CLI
~~~bash
./bin/fdml validate <file-or-dir> [--json]
./bin/fdml validate-sch <file-or-dir> [--json]
./bin/fdml validate-all <file-or-dir> [--json]
./bin/fdml render <fdml-file> [--out out.html]
~~~

### Exit codes
- **0** = OK
- **2** = Validation errors (XSD or Schematron)
- **3** = Transform/render error
- **4** = I/O / usage error

### Examples
~~~bash
./bin/fdml validate corpus/valid
./bin/fdml validate-sch corpus/valid --json
./bin/fdml validate-all corpus/valid --json
./bin/fdml render corpus/valid/example-01.fdml.xml --out out/example-01.html
~~~

## Sequences
FDML supports assembling routines via `<sequence>`:
```xml
<body>
  <figure id="f-basic">…</figure>
  <figure id="f-turn">…</figure>
  <sequence name="Teaching Set">
    <use figure="f-basic" repeat="2"/>
    <use figure="f-turn" repeat="2"/>
  </sequence>
</body>

--- END docs/USAGE.md ---
--- BEGIN docs/index.html ---
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>FDML — Folk Dance Markup Language</title>
    <link rel="stylesheet" href="site.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="hero">
        <div>
          <h1>FDML</h1>
          <div class="muted">Folk Dance Markup Language — schema, validator, and live examples</div>
          <div class="nav">
            <a class="cta" href="USAGE.html">Usage</a>
            <a class="cta" href="examples/index.html">Examples</a>
            <a href="https://github.com/`whoami`/fdml-core">Repo</a>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:24px">
        <div class="card">
          <h3>Validate</h3>
          <p>Check FDML files with XSD + Schematron.</p>
          <a class="cta" href="USAGE.html#cli">CLI</a>
        </div>
        <div class="card">
          <h3>Render</h3>
          <p>Turn FDML into clean, printable figure cards.</p>
          <a class="cta" href="examples/index.html">See examples</a>
        </div>
        <div class="card">
          <h3>Sequences</h3>
          <p>Reuse figures with <code>&lt;sequence&gt;</code> and per-use subtotals.</p>
          <a class="cta" href="examples/example-04.fdml.html">Sequence demo</a>
        </div>
      </div>
    </div>
  </body>
</html>

--- END docs/index.html ---
--- BEGIN docs/progress-report/README.md ---
# Progress Reports

This folder contains weekly progress reports for the FDML project.

## Week 5
- `week05_progress.tex` — LaTeX report (compile with `pdflatex week05_progress.tex`).
- Covers: packaging, CI matrix, corpus/validation work, rendering pipeline, Pages publishing, issues and next steps.


--- END docs/progress-report/README.md ---
--- BEGIN docs/progress-report/week05_progress.tex ---
\documentclass[11pt,a4paper]{article}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\usepackage{enumitem}
\usepackage{titlesec}
\usepackage{xcolor}
\hypersetup{colorlinks=true,linkcolor=blue,urlcolor=blue}

\titleformat{\section}{\large\bfseries}{\thesection}{0.6em}{}
\titleformat{\subsection}{\normalsize\bfseries}{\thesubsection}{0.5em}{}

\title{\textbf{FDML Project — Week 5 Progress Report}}
\author{Shivsaransthakur1-Coder}
\date{\today}

\begin{document}
\maketitle

\section{Executive Summary}
\begin{itemize}[leftmargin=1.2em]
  \item Delivered a functional CLI release pipeline (\texttt{fdml-core} v0.3.3) packaged via Homebrew tap, plus validation and rendering workflows.
  \item Built a curated, styled GitHub Pages site that publishes rendered FDML examples as printable cards.
  \item Established repeatable CI for schema/corpus validation and for site rendering; resolved several publishing and cache-busting issues.
  \item Current focus: unifying stylesheet delivery for card pages and finalizing “professional” presentation and navigation UX.
\end{itemize}

\section{Scope and Repositories}
\begin{itemize}[leftmargin=1.2em]
  \item \textbf{Core}: \texttt{fdml-core} — XSD schema, Schematron rules, XSLT renderer, CLI JAR, corpus and documentation.
  \item \textbf{Packaging}: \texttt{homebrew-fdml} tap — installs \texttt{fdml} CLI (\texttt{fdml-core.jar}) and ships schema resources.
\end{itemize}

\section{What Was Completed}
\subsection{Schema, Corpus, CLI}
\begin{itemize}[leftmargin=1.2em]
  \item Authored FDML XSD (\texttt{schema/}) and Schematron rules (\texttt{schematron/}).
  \item Sample corpus in \texttt{corpus/valid} and \texttt{corpus/invalid}; invalid samples ensured to fail XSD deterministically.
  \item CLI packaging as \texttt{fdml-core.jar}; Homebrew formula updated to v0.3.3 with verified SHA256.
\end{itemize}

\subsection{Local Developer Tooling}
\begin{itemize}[leftmargin=1.2em]
  \item \texttt{make ci} validates all valid and invalid samples.
  \item \texttt{make json} emits machine-readable results for valid samples.
  \item \texttt{make html} renders cards via XSLT into \texttt{out/html}.
\end{itemize}

\subsection{CI/CD Workflows}
\begin{itemize}[leftmargin=1.2em]
  \item \textbf{tap-test} and \textbf{tap-audit}: formula style/audit and install/validate smoke tests.
  \item \textbf{fdml-validate}: corpus validation in CI (valid must pass; invalid must fail).
  \item \textbf{render-test}: builds HTML cards in CI and uploads artifacts.
  \item \textbf{cards-pages}: publishes styled site to GitHub Pages from \texttt{site/}.
\end{itemize}

\subsection{Website Publishing}
\begin{itemize}[leftmargin=1.2em]
  \item Static site structure: \texttt{site/index.html} (grid of examples) and \texttt{site/cards/*.html} (card pages).
  \item Central stylesheet at \texttt{site/style.css}; cache-buster parameter threaded via CI and local builds.
  \item Example pages link back to index and include minimal site header for consistency.
\end{itemize}

\section{Issues Found and Fixed}
\subsection{Repeatability and Validation}
\begin{itemize}[leftmargin=1.2em]
  \item Several invalid corpus samples initially passed; replaced with deterministic XSD failures.
  \item CI portability: adapted shell loops to macOS runner (bash 3.2) semantics.
\end{itemize}

\subsection{Publishing and Caching}
\begin{itemize}[leftmargin=1.2em]
  \item Intermittent 404s traced to artifact content vs. links and Pages cache; added explicit cache-busting and ensured index generation in CI.
  \item Addressed duplicated output (\texttt{site/} vs. \texttt{site/cards/}) and removed embedded repos from tree (avoids Pages conflicts).
\end{itemize}

\section{Open Items / Known Gaps}
\begin{itemize}[leftmargin=1.2em]
  \item Some card pages reverted to unstyled look due to stylesheet path assumptions; fix is to link cards to \texttt{../style.css} and ship a single root CSS.
  \item Strengthen validation outputs (attach JSON for CI artifacts) and add regression checks for Pages contents.
  \item Improve table formatting and content density for long figure lists; add print CSS for page breaks.
\end{itemize}

\section{Next Steps (Week 5 Plan)}
\begin{enumerate}[leftmargin=1.2em]
  \item Finalize stylesheet unification and verify on Pages: card head should reference \texttt{../style.css?\{version\}}.
  \item Extend CI to diff rendered HTML structure and ensure head links, header/nav and back-links are intact.
  \item Author tutorial docs: ``Authoring FDML'', ``Validating FDML'', ``Rendering Cards''; link from landing page.
  \item Prepare a tagged demo release and attach Pages URL and artifacts to GitHub Release notes.
\end{enumerate}

\section{Appendix — CI Matrix}
\begin{itemize}[leftmargin=1.2em]
  \item \textbf{tap-test}: install \& validate smoke.
  \item \textbf{tap-audit}: style/audit; no redundant \texttt{version} stanza in formula.
  \item \textbf{fdml-validate}: macOS; brew install \texttt{fdml}; run validation loops.
  \item \textbf{render-test}: brew install \texttt{fdml} and \texttt{libxslt}; \texttt{make html}; upload artifact.
  \item \textbf{cards-pages}: macOS build \textrightarrow{} Ubuntu deploy to Pages; cache-busted \texttt{site/} published.
\end{itemize}

\end{document}

--- END docs/progress-report/week05_progress.tex ---
--- BEGIN homebrew-fdml/Formula/fdml.rb ---
class Fdml < Formula
  desc "Folk Dance Markup Language CLI"
  homepage "https://shivsaranshthakur1-coder.github.io/fdml-core/"
  url "https://github.com/ShivsaranshThakur1-Coder/fdml-core/releases/download/v0.3.0/fdml-core.jar", using: :nounzip
  version "0.3.0"
  sha256 "PASTE_SHA256_HERE"

  depends_on "openjdk@17"

  def install
    libexec.install "fdml-core.jar"
    (bin/"fdml").write <<~EOS
      #!/usr/bin/env bash
      exec "#{Formula["openjdk@17"].opt_bin}/java" -jar "#{libexec}/fdml-core.jar" "$@"
    EOS
    chmod 0555, bin/"fdml"
  end

  test do
    (testpath/"t.fdml.xml").write <<~XML
      <?xml version="1.0" encoding="UTF-8"?>
      <fdml version="1.0">
        <meta><title>t</title></meta>
        <body><section id="s-1">ok</section></body>
      </fdml>
    XML
    system "#{bin}/fdml", "validate", testpath/"t.fdml.xml"
  end
end

--- END homebrew-fdml/Formula/fdml.rb ---
--- BEGIN .github/workflows/ci.yml ---
name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build shaded jar
        run: mvn -q -DskipTests package
        shell: bash

      - name: XSD — valid corpus should pass
        run: java -jar target/fdml-core.jar validate corpus/valid
        shell: bash

      - name: Schematron — valid corpus should pass
        run: java -jar target/fdml-core.jar validate-sch corpus/valid
        shell: bash

      - name: XSD — invalid corpus should fail
        run: |
          set +e
          java -jar target/fdml-core.jar validate corpus/invalid
          s=$?
          if [ $s -eq 0 ]; then echo "Expected invalid corpus to fail XSD, but it passed"; exit 1; else echo "Invalid corpus correctly failed XSD"; fi
        shell: bash

      - name: Schematron — invalid corpus should fail
        run: |
          set +e
          java -jar target/fdml-core.jar validate-sch corpus/invalid
          s=$?
          if [ $s -eq 0 ]; then echo "Expected invalid corpus to fail Schematron, but it passed"; exit 1; else echo "Invalid corpus correctly failed Schematron"; fi
        shell: bash

      - name: Doctor — valid corpus strict gate
        run: java -jar target/fdml-core.jar doctor corpus/valid --strict
        shell: bash

      - name: Run tests
        run: mvn -q test
        shell: bash

--- END .github/workflows/ci.yml ---
--- BEGIN .github/workflows/fdml-validate.yml ---
name: fdml-validate
on:
  push:
  pull_request:
  workflow_dispatch:
jobs:
  validate:
    runs-on: macOS-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Homebrew/actions/setup-homebrew@master
      - run: brew update-reset
      - run: brew tap ShivsaranshThakur1-Coder/homebrew-fdml
      - run: brew install fdml
      - name: Validate valid corpus (should pass)
        shell: bash
        run: |
          tmp=$(mktemp)
          find corpus/valid -type f -name '*.xml' | sort > "$tmp"
          count=$(wc -l < "$tmp" | tr -d ' ')
          echo "Valid files: $count"
          while IFS= read -r f; do
            echo "::group::valid $f"
            fdml validate "$f"
            echo "::endgroup::"
          done < "$tmp"
          rm -f "$tmp"
      - name: Validate invalid corpus (should fail)
        shell: bash
        run: |
          tmp=$(mktemp)
          find corpus/invalid -type f -name '*.xml' | sort > "$tmp"
          count=$(wc -l < "$tmp" | tr -d ' ')
          echo "Invalid files: $count"
          failures=0
          while IFS= read -r f; do
            echo "::group::invalid $f"
            if fdml validate "$f"; then
              echo "EXPECTED FAILURE but got success: $f"
              failures=$((failures+1))
            fi
            echo "::endgroup::"
          done < "$tmp"
          rm -f "$tmp"
          test $failures -eq 0

--- END .github/workflows/fdml-validate.yml ---
--- BEGIN .github/workflows/render-test.yml ---
name: render-test
on:
  workflow_dispatch:
  push:
  pull_request:
jobs:
  render:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Homebrew/actions/setup-homebrew@master
      - run: brew update-reset
      - run: brew tap ShivsaranshThakur1-Coder/homebrew-fdml
      - run: brew install fdml libxslt
      - run: make html
      - name: Archive HTML
        run: tar -czf out-html.tgz -C out/html .
      - uses: actions/upload-artifact@v4
        with:
          name: html-cards
          path: out-html.tgz

--- END .github/workflows/render-test.yml ---
--- BEGIN .github/workflows/cards-pages.yml ---
name: cards-pages
on:
  workflow_dispatch:
  # publish when these change in fdml-core
  push:
    paths:
      - 'corpus/**'
      - 'xslt/**'
      - 'Makefile'
      - 'docs/style.css'
      - 'scripts/build_index*.sh'
      - '.github/workflows/cards-pages.yml'
permissions:
  contents: read
  pages: write
  id-token: write
concurrency:
  group: 'pages'
  cancel-in-progress: true
jobs:
  build:
    runs-on: macOS-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Homebrew/actions/setup-homebrew@master
      - run: brew update-reset
      - run: brew tap ShivsaranshThakur1-Coder/homebrew-fdml
      - run: brew install fdml
      - run: CSSV=${{ github.run_id }} make html
      - run: bash scripts/build_index.sh ${{ github.run_id }}
      - uses: actions/upload-pages-artifact@v3
        with:
          path: site
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4

--- END .github/workflows/cards-pages.yml ---
--- BEGIN .github/workflows/release.yml ---
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Build shaded jar and PDFs
        run: |
          mvn -q -DskipTests package
          ./scripts/gen_examples.sh
          cd docs && zip -r ../fdml-pdfs.zip pdfs
      - name: Create GitHub Release (attach artifacts)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/fdml-core.jar
            fdml-pdfs.zip

--- END .github/workflows/release.yml ---
--- BEGIN schema/fdml.xsd ---
<?xml version="1.0" encoding="UTF-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified">

  <xs:simpleType name="idSection">
    <xs:restriction base="xs:string">
      <xs:pattern value="s-[a-z0-9-]+"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:simpleType name="idFigure">
    <xs:restriction base="xs:string">
      <xs:pattern value="f-[a-z0-9-]+"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:simpleType name="foot">
    <xs:restriction base="xs:string">
      <xs:enumeration value="L"/>
      <xs:enumeration value="R"/>
      <xs:enumeration value="B"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:simpleType name="who">
    <xs:restriction base="xs:string">
      <xs:enumeration value="lead"/>
      <xs:enumeration value="follow"/>
      <xs:enumeration value="both"/>
      <xs:enumeration value="all"/>
      <xs:enumeration value="gents"/>
      <xs:enumeration value="ladies"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:simpleType name="direction">
    <xs:restriction base="xs:string">
      <xs:enumeration value="Fwd"/>
      <xs:enumeration value="Back"/>
      <xs:enumeration value="Left"/>
      <xs:enumeration value="Right"/>
      <xs:enumeration value="CW"/>
      <xs:enumeration value="CCW"/>
      <xs:enumeration value="In"/>
      <xs:enumeration value="Out"/>
      <xs:enumeration value="DiagL"/>
      <xs:enumeration value="DiagR"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:simpleType name="facing">
    <xs:restriction base="xs:string">
      <xs:enumeration value="N"/>
      <xs:enumeration value="E"/>
      <xs:enumeration value="S"/>
      <xs:enumeration value="W"/>
      <xs:enumeration value="Partner"/>
      <xs:enumeration value="Inside"/>
      <xs:enumeration value="Outside"/>
      <xs:enumeration value="Up"/>
      <xs:enumeration value="Down"/>
      <xs:enumeration value="Across"/>
      <xs:enumeration value="Along"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:simpleType name="formation">
    <xs:restriction base="xs:string">
      <xs:enumeration value="circle"/>
      <xs:enumeration value="line"/>
      <xs:enumeration value="couple"/>
      <xs:enumeration value="set"/>
      <xs:enumeration value="square"/>
      <xs:enumeration value="improper"/>
      <xs:enumeration value="longways"/>
      <xs:enumeration value="ring"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:simpleType name="countSpan">
    <xs:restriction base="xs:string">
      <xs:pattern value="\d+(-\d+)?"/>
    </xs:restriction>
  </xs:simpleType>

  <xs:complexType name="sectionType">
    <xs:simpleContent>
      <xs:extension base="xs:string">
        <xs:attribute name="id" type="idSection" use="optional"/>
      </xs:extension>
    </xs:simpleContent>
  </xs:complexType>

  <xs:complexType name="stepType">
    <xs:simpleContent>
      <xs:extension base="xs:string">
        <xs:attribute name="who" type="who" use="required"/>
        <xs:attribute name="action" type="xs:string" use="required"/>
        <xs:attribute name="beats" type="xs:positiveInteger" use="required"/>
        <xs:attribute name="count" type="countSpan" use="optional"/>
        <xs:attribute name="startFoot" type="foot" use="required"/>
        <xs:attribute name="endFoot" type="foot" use="optional"/>
        <xs:attribute name="direction" type="direction" use="optional"/>
        <xs:attribute name="facing" type="facing" use="optional"/>
      </xs:extension>
    </xs:simpleContent>
  </xs:complexType>

  <xs:complexType name="figureType">
    <xs:sequence>
      <xs:element name="step" type="stepType" minOccurs="1" maxOccurs="unbounded"/>
    </xs:sequence>
    <xs:attribute name="id" type="idFigure" use="required"/>
    <xs:attribute name="name" type="xs:string" use="optional"/>
    <xs:attribute name="formation" type="formation" use="optional"/>
  </xs:complexType>

  <xs:complexType name="useType">
    <xs:attribute name="figure" type="idFigure" use="required"/>
    <xs:attribute name="repeat" type="xs:positiveInteger" use="optional" default="1"/>
  </xs:complexType>

  <xs:complexType name="sequenceType">
    <xs:sequence>
      <xs:element name="use" type="useType" minOccurs="1" maxOccurs="unbounded"/>
    </xs:sequence>
    <xs:attribute name="name" type="xs:string" use="optional"/>
  </xs:complexType>

  <xs:complexType name="metaType">
    <xs:sequence>
      <xs:element name="title" type="xs:string" minOccurs="1" maxOccurs="1"/>
      <xs:element name="dance" minOccurs="0" maxOccurs="1">
        <xs:complexType><xs:attribute name="name" type="xs:string" use="required"/></xs:complexType>
      </xs:element>
      <xs:element name="meter" minOccurs="0" maxOccurs="1">
        <xs:complexType><xs:attribute name="value" type="xs:string" use="required"/></xs:complexType>
      </xs:element>
      <xs:element name="tempo" minOccurs="0" maxOccurs="1">
        <xs:complexType><xs:attribute name="bpm" type="xs:positiveInteger" use="required"/></xs:complexType>
      </xs:element>
      <xs:element name="author" minOccurs="0" maxOccurs="1">
        <xs:complexType>
          <xs:simpleContent>
            <xs:extension base="xs:string">
              <xs:attribute name="email" type="xs:string" use="optional"/>
            </xs:extension>
          </xs:simpleContent>
        </xs:complexType>
      </xs:element>
    </xs:sequence>
  </xs:complexType>

  <xs:complexType name="bodyType">
    <xs:choice minOccurs="1" maxOccurs="unbounded">
      <xs:element name="section" type="sectionType"/>
      <xs:element name="figure" type="figureType"/>
      <xs:element name="sequence" type="sequenceType"/>
    </xs:choice>
  </xs:complexType>

  <xs:element name="fdml">
    <xs:complexType>
      <xs:sequence>
        <xs:element name="meta" type="metaType"/>
        <xs:element name="body" type="bodyType"/>
      </xs:sequence>
      <xs:attribute name="version" type="xs:string" use="required" fixed="1.0"/>
    </xs:complexType>
  </xs:element>

</xs:schema>

--- END schema/fdml.xsd ---
--- BEGIN schematron/fdml.sch ---
<?xml version="1.0" encoding="UTF-8"?>
<schema xmlns="http://purl.oclc.org/dsdl/schematron">
  <pattern id="basic-rules">
    <rule context="fdml">
      <assert test="meta">fdml must contain meta</assert>
      <assert test="body">fdml must contain body</assert>
    </rule>
  </pattern>
</schema>

--- END schematron/fdml.sch ---
--- BEGIN schematron/fdml-compiled.xsl ---
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="2.0"
  xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
  xmlns:svrl="http://purl.oclc.org/dsdl/svrl">
  <xsl:output method="xml" indent="yes"/>

  <xsl:template match="/"><svrl:schematron-output><xsl:apply-templates select="/*"/></svrl:schematron-output></xsl:template>

  <xsl:template match="fdml">
    <xsl:if test="not(meta)"><svrl:failed-assert><svrl:text>fdml must contain meta</svrl:text></svrl:failed-assert></xsl:if>
    <xsl:if test="not(body)"><svrl:failed-assert><svrl:text>fdml must contain body</svrl:text></svrl:failed-assert></xsl:if>
    <xsl:if test="not(normalize-space(meta/title))"><svrl:failed-assert><svrl:text>meta/title must be present and non-empty</svrl:text></svrl:failed-assert></xsl:if>
    <xsl:if test="string-length(normalize-space(meta/title)) &gt; 120"><svrl:failed-assert><svrl:text>meta/title must be ≤ 120 characters</svrl:text></svrl:failed-assert></xsl:if>
    <xsl:variable name="email" select="normalize-space(meta/author/@email)"/>
    <xsl:if test="meta/author/@email and not(matches($email, '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'))"><svrl:failed-assert><svrl:text>meta/author/@email is not a valid email</svrl:text></svrl:failed-assert></xsl:if>
    <xsl:if test="body and not(body/section or body/figure or body/sequence)"><svrl:failed-assert><svrl:text>body must contain at least one &lt;section&gt; or &lt;figure&gt; or &lt;sequence&gt;</svrl:text></svrl:failed-assert></xsl:if>
    <xsl:apply-templates select="body"/>
  </xsl:template>

  <xsl:template match="body">
    <xsl:for-each select="figure">
      <xsl:if test="not(@id)"><svrl:failed-assert><svrl:text>figure must have @id</svrl:text></svrl:failed-assert></xsl:if>
      <xsl:if test="@id and not(matches(@id, '^f-[a-z0-9-]+$'))"><svrl:failed-assert><svrl:text>figure/@id must match pattern 'f-[a-z0-9-]+'</svrl:text></svrl:failed-assert></xsl:if>
      <xsl:if test="@id and count(//figure[@id=current()/@id]) &gt; 1"><svrl:failed-assert><svrl:text>figure/@id values must be unique across the document</svrl:text></svrl:failed-assert></xsl:if>
      <xsl:if test="not(step)"><svrl:failed-assert><svrl:text>figure must contain at least one step</svrl:text></svrl:failed-assert></xsl:if>
      <xsl:for-each select="step">
        <xsl:if test="not(@beats) or number(@beats) &lt; 1"><svrl:failed-assert><svrl:text>step/@beats must be ≥ 1</svrl:text></svrl:failed-assert></xsl:if>
        <xsl:if test="not(@who)"><svrl:failed-assert><svrl:text>step/@who is required</svrl:text></svrl:failed-assert></xsl:if>
        <xsl:if test="not(@startFoot)"><svrl:failed-assert><svrl:text>step/@startFoot is required</svrl:text></svrl:failed-assert></xsl:if>
      </xsl:for-each>
    </xsl:for-each>

    <xsl:for-each select="sequence/use">
      <xsl:variable name="t" select="@figure"/>
      <xsl:if test="count(//figure[@id=$t]) = 0"><svrl:failed-assert><svrl:text>sequence/use/@figure must reference an existing figure id</svrl:text></svrl:failed-assert></xsl:if>
    </xsl:for-each>
  </xsl:template>

  <xsl:template match="@*|node()"><xsl:apply-templates select="@*|node()"/></xsl:template>
</xsl:stylesheet>

--- END schematron/fdml-compiled.xsl ---
--- BEGIN xslt/card.xsl ---
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:param name="cssVersion" select="'0'"/>

  <xsl:template match="/">
    <html lang="en">
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <meta name="color-scheme" content="dark light"/>
        <title>FDML: <xsl:value-of select="/fdml/meta/title"/></title>
        <link rel="stylesheet" href="../style.css?{}"/>
      </head>
      <body>
        <header class="site-head"><div class="container">
          <a class="brand" href="index.html">FDML</a>
          <nav class="nav"><a href="index.html">Examples</a>
            <a href="https://github.com/ShivsaranshThakur1-Coder/fdml-core" target="_blank" rel="noopener">GitHub</a>
          </nav>
        </div></header>
        <main class="container">
          <div class="card">
            <h1><xsl:value-of select="/fdml/meta/title"/></h1>
            <p class="sub"><span>Meter <code><xsl:value-of select="/fdml/meta/meter"/></code></span>
               &#160;•&#160;
               <span>Tempo <code><xsl:value-of select="/fdml/meta/tempo"/></code></span>
            </p>
            <xsl:if test="/fdml/body/figure">
              <table>
                <thead><tr><th>Figure</th><th>Name</th></tr></thead>
                <tbody>
                  <xsl:for-each select="/fdml/body/figure">
                    <tr>
                      <td><code><xsl:value-of select="@id"/></code></td>
                      <td><xsl:value-of select="@name"/></td>
                    </tr>
                  </xsl:for-each>
                </tbody>
              </table>
            </xsl:if>
            <p class="sub">Generated from FDML</p>
            <p class="sub"><a class="muted" href="index.html">← Back to all examples</a></p>
          </div>
        </main>
        <footer><div class="container">© FDML</div></footer>
      </body>
    </html>
  </xsl:template>
</xsl:stylesheet>

--- END xslt/card.xsl ---
--- BEGIN xslt/fdml-to-card.xsl ---
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:output method="html" indent="yes"/>
  <xsl:key name="figById" match="figure" use="@id"/>

  <xsl:template match="/">
    <html>
      <head>
        <title>
          <xsl:value-of select="normalize-space(/fdml/meta/title)"/>
        </title>
        <link rel="stylesheet" href="../site.css"/>
        <link rel="stylesheet" href="../css/print.css"/>
      </head>
      <body>
        <div class="wrap">
          <div class="nav"><a href="index.html">← Examples</a></div>
          <xsl:apply-templates select="fdml"/>
        </div>
      </body>
    </html>
  </xsl:template>

  <xsl:template match="fdml">
    <div class="fdml">
      <div class="meta">
        <div class="title"><xsl:value-of select="normalize-space(meta/title)"/></div>
        <xsl:if test="meta/dance/@name"><div class="muted">Dance: <xsl:value-of select="meta/dance/@name"/></div></xsl:if>
        <xsl:if test="meta/meter/@value"><div class="muted">Meter: <xsl:value-of select="meta/meter/@value"/></div></xsl:if>
        <xsl:if test="meta/tempo/@bpm"><div class="muted">Tempo: <xsl:value-of select="meta/tempo/@bpm"/> bpm</div></xsl:if>
      </div>

      <xsl:if test="body/sequence">
        <xsl:for-each select="body/sequence">
          <xsl:call-template name="sequenceCard"/>
        </xsl:for-each>
      </xsl:if>

      <xsl:for-each select="body/figure">
        <xsl:call-template name="figureCard"/>
      </xsl:for-each>

      <xsl:apply-templates select="body/section"/>
    </div>
  </xsl:template>

  <xsl:template name="sequenceCard">
    <xsl:variable name="meterVal" select="/fdml/meta/meter/@value"/>
    <xsl:variable name="beatsPerBar" select="number(substring-before($meterVal, '/'))"/>
    <xsl:variable name="grand" select="sum(for $u in use return (sum(key('figById', $u/@figure)/step/@beats) * (if ($u/@repeat) then number($u/@repeat) else 1)))"/>
    <xsl:variable name="bars" select="if ($beatsPerBar gt 0) then ($grand div $beatsPerBar) else ()"/>
    <div class="figure-card">
      <h2>
        <xsl:text>Sequence</xsl:text>
        <xsl:if test="@name"><xsl:text>: </xsl:text><xsl:value-of select="@name"/></xsl:if>
        <span class="beats">
          <xsl:text> — Total: </xsl:text><xsl:value-of select="$grand"/><xsl:text> beats</xsl:text>
          <xsl:if test="$bars"><xsl:text> (~</xsl:text><xsl:value-of select="format-number($bars,'0.##')"/><xsl:text> bars @ </xsl:text><xsl:value-of select="$meterVal"/><xsl:text>)</xsl:text></xsl:if>
        </span>
      </h2>
      <table class="steps">
        <thead><tr><th>#</th><th>Figure</th><th>Name</th><th>Repeat</th><th>Beats each</th><th>Subtotal</th></tr></thead>
        <tbody>
          <xsl:for-each select="use">
            <xsl:variable name="fig" select="key('figById', @figure)[1]"/>
            <xsl:variable name="rep" select="if (@repeat) then number(@repeat) else 1"/>
            <xsl:variable name="each" select="sum($fig/step/@beats)"/>
            <xsl:variable name="sub" select="$each * $rep"/>
            <tr>
              <td><xsl:value-of select="position()"/></td>
              <td><code><xsl:value-of select="@figure"/></code></td>
              <td><xsl:value-of select="$fig/@name"/></td>
              <td><xsl:value-of select="$rep"/></td>
              <td><xsl:value-of select="$each"/></td>
              <td><xsl:value-of select="$sub"/></td>
            </tr>
          </xsl:for-each>
        </tbody>
      </table>
    </div>
  </xsl:template>

  <xsl:template name="figureCard">
    <xsl:variable name="beats" select="sum(step/@beats)"/>
    <xsl:variable name="meterVal" select="/fdml/meta/meter/@value"/>
    <xsl:variable name="beatsPerBar" select="number(substring-before($meterVal, '/'))"/>
    <xsl:variable name="bars" select="if ($beatsPerBar gt 0) then ($beats div $beatsPerBar) else ()"/>
    <div class="figure-card">
      <h2>
        <xsl:text>Figure</xsl:text>
        <xsl:if test="@name"><xsl:text>: </xsl:text><xsl:value-of select="@name"/></xsl:if>
        <xsl:if test="@formation"><xsl:text> (</xsl:text><xsl:value-of select="@formation"/><xsl:text>)</xsl:text></xsl:if>
        <span class="beats">
          <xsl:text> — Total: </xsl:text><xsl:value-of select="$beats"/><xsl:text> beats</xsl:text>
          <xsl:if test="$bars"><xsl:text> (~</xsl:text><xsl:value-of select="format-number($bars,'0.##')"/><xsl:text> bars @ </xsl:text><xsl:value-of select="$meterVal"/><xsl:text>)</xsl:text></xsl:if>
        </span>
      </h2>
      <table class="steps">
        <thead><tr><th>#</th><th>Who</th><th>Action</th><th>Beats</th><th>Count</th><th>Foot</th><th>Direction</th><th>Facing</th><th>Notes</th></tr></thead>
        <tbody>
          <xsl:for-each select="step">
            <tr>
              <td><xsl:value-of select="position()"/></td>
              <td><xsl:value-of select="@who"/></td>
              <td><xsl:value-of select="@action"/></td>
              <td><xsl:value-of select="@beats"/></td>
              <td><xsl:value-of select="@count"/></td>
              <td><xsl:value-of select="@startFoot"/><xsl:if test="@endFoot"><xsl:text>→</xsl:text><xsl:value-of select="@endFoot"/></xsl:if></td>
              <td><xsl:value-of select="@direction"/></td>
              <td><xsl:value-of select="@facing"/></td>
              <td><xsl:value-of select="normalize-space(.)"/></td>
            </tr>
          </xsl:for-each>
        </tbody>
      </table>
    </div>
  </xsl:template>

  <xsl:template match="section">
    <div class="section"><xsl:value-of select="normalize-space(.)"/></div>
  </xsl:template>

  <xsl:template match="@*|node()">
    <xsl:apply-templates select="@*|node()"/>
  </xsl:template>
</xsl:stylesheet>

--- END xslt/fdml-to-card.xsl ---
--- BEGIN xslt/fdml-to-xhtml.xsl ---
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                xmlns="http://www.w3.org/1999/xhtml">
  <xsl:output method="xhtml" indent="yes" />

  <xsl:template match="/">
    <html>
      <head>
        <title><xsl:value-of select="normalize-space(/fdml/meta/title)"/></title>
        <link rel="stylesheet" href="../site.css" />
        <link rel="stylesheet" href="../css/print.css" />
      </head>
      <body>
        <div class="wrap">
          <div class="nav"><a href="index.html">← Examples</a></div>
          <xsl:apply-templates select="fdml"/>
        </div>
      </body>
    </html>
  </xsl:template>

  <xsl:template match="fdml">
    <div class="fdml">
      <div class="meta">
        <div class="title"><xsl:value-of select="normalize-space(meta/title)"/></div>
        <xsl:if test="meta/dance/@name"><div class="muted">Dance: <xsl:value-of select="meta/dance/@name"/></div></xsl:if>
        <xsl:if test="meta/meter/@value"><div class="muted">Meter: <xsl:value-of select="meta/meter/@value"/></div></xsl:if>
        <xsl:if test="meta/tempo/@bpm"><div class="muted">Tempo: <xsl:value-of select="meta/tempo/@bpm"/> bpm</div></xsl:if>
      </div>

      <xsl:if test="body/sequence">
        <xsl:for-each select="body/sequence"><xsl:call-template name="sequenceCard"/></xsl:for-each>
      </xsl:if>

      <xsl:for-each select="body/figure"><xsl:call-template name="figureCard"/></xsl:for-each>
      <xsl:apply-templates select="body/section"/>
    </div>
  </xsl:template>

  <xsl:template name="sequenceCard">
    <xsl:variable name="meterVal" select="/fdml/meta/meter/@value"/>
    <xsl:variable name="beatsPerBar" select="number(substring-before($meterVal, '/'))"/>
    <xsl:variable name="grand" select="sum(for $u in use return (sum(key('figById', $u/@figure)/step/@beats) * (if ($u/@repeat) then number($u/@repeat) else 1)))"/>
    <xsl:variable name="bars" select="if ($beatsPerBar gt 0) then ($grand div $beatsPerBar) else ()"/>
    <div class="figure-card">
      <h2>
        <xsl:text>Sequence</xsl:text>
        <xsl:if test="@name"><xsl:text>: </xsl:text><xsl:value-of select="@name"/></xsl:if>
        <span class="beats">
          <xsl:text> — Total: </xsl:text><xsl:value-of select="$grand"/><xsl:text> beats</xsl:text>
          <xsl:if test="$bars"><xsl:text> (~</xsl:text><xsl:value-of select="format-number($bars,'0.##')"/><xsl:text> bars @ </xsl:text><xsl:value-of select="$meterVal"/><xsl:text>)</xsl:text></xsl:if>
        </span>
      </h2>
      <table class="steps">
        <thead><tr><th>#</th><th>Figure</th><th>Name</th><th>Repeat</th><th>Beats each</th><th>Subtotal</th></tr></thead>
        <tbody>
          <xsl:for-each select="use">
            <xsl:variable name="fig" select="key('figById', @figure)[1]"/>
            <xsl:variable name="rep" select="if (@repeat) then number(@repeat) else 1"/>
            <xsl:variable name="each" select="sum($fig/step/@beats)"/>
            <xsl:variable name="sub" select="$each * $rep"/>
            <tr>
              <td><xsl:value-of select="position()"/></td>
              <td><code><xsl:value-of select="@figure"/></code></td>
              <td><xsl:value-of select="$fig/@name"/></td>
              <td><xsl:value-of select="$rep"/></td>
              <td><xsl:value-of select="$each"/></td>
              <td><xsl:value-of select="$sub"/></td>
            </tr>
          </xsl:for-each>
        </tbody>
      </table>
    </div>
  </xsl:template>

  <xsl:key name="figById" match="figure" use="@id"/>

  <xsl:template name="figureCard">
    <xsl:variable name="beats" select="sum(step/@beats)"/>
    <xsl:variable name="meterVal" select="/fdml/meta/meter/@value"/>
    <xsl:variable name="beatsPerBar" select="number(substring-before($meterVal, '/'))"/>
    <xsl:variable name="bars" select="if ($beatsPerBar gt 0) then ($beats div $beatsPerBar) else ()"/>
    <div class="figure-card">
      <h2>
        <xsl:text>Figure</xsl:text>
        <xsl:if test="@name"><xsl:text>: </xsl:text><xsl:value-of select="@name"/></xsl:if>
        <xsl:if test="@formation"><xsl:text> (</xsl:text><xsl:value-of select="@formation"/><xsl:text>)</xsl:text></xsl:if>
        <span class="beats">
          <xsl:text> — Total: </xsl:text><xsl:value-of select="$beats"/><xsl:text> beats</xsl:text>
          <xsl:if test="$bars"><xsl:text> (~</xsl:text><xsl:value-of select="format-number($bars,'0.##')"/><xsl:text> bars @ </xsl:text><xsl:value-of select="$meterVal"/><xsl:text>)</xsl:text></xsl:if>
        </span>
      </h2>
      <table class="steps">
        <thead><tr><th>#</th><th>Who</th><th>Action</th><th>Beats</th><th>Count</th><th>Foot</th><th>Direction</th><th>Facing</th><th>Notes</th></tr></thead>
        <tbody>
          <xsl:for-each select="step">
            <tr>
              <td><xsl:value-of select="position()"/></td>
              <td><xsl:value-of select="@who"/></td>
              <td><xsl:value-of select="@action"/></td>
              <td><xsl:value-of select="@beats"/></td>
              <td><xsl:value-of select="@count"/></td>
              <td><xsl:value-of select="@startFoot"/><xsl:if test="@endFoot"><xsl:text>→</xsl:text><xsl:value-of select="@endFoot"/></xsl:if></td>
              <td><xsl:value-of select="@direction"/></td>
              <td><xsl:value-of select="@facing"/></td>
              <td><xsl:value-of select="normalize-space(.)"/></td>
            </tr>
          </xsl:for-each>
        </tbody>
      </table>
    </div>
  </xsl:template>

  <xsl:template match="section"><div class="section"><xsl:value-of select="normalize-space(.)"/></div></xsl:template>
  <xsl:template match="@*|node()"><xsl:apply-templates select="@*|node()"/></xsl:template>
</xsl:stylesheet>

--- END xslt/fdml-to-xhtml.xsl ---
--- BEGIN xslt/style.css ---
:root{
  --bg:#0b1020; --panel:#0f172a; --ink:#e6edf3; --muted:#a4b1c3; --accent:#22c55e; --accent-ink:#062d16; --border:#1f2937; --ring:0 0 0 3px rgba(34,197,94,.25);
  --shadow:0 2px 10px rgba(2,6,23,.35), 0 1px 0 rgba(255,255,255,.02) inset
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f6f8fa; --panel:#ffffff; --ink:#0f172a; --muted:#475569; --accent:#2563eb; --accent-ink:#0b3a72; --border:#e5e7eb; --shadow:0 2px 12px rgba(2,6,23,.06) }
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:15.5px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
  color:var(--ink); background:var(--bg);
}
.container{max-width:1120px; margin:56px auto; padding:0 24px}
.site-head{position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(10px); background:color-mix(in hsl, var(--bg) 90%, transparent); border-bottom:1px solid var(--border)}
.site-head .container{display:flex; align-items:center; justify-content:space-between; margin:0 auto; padding:14px 24px}
.brand{font-weight:800; letter-spacing:.2px; text-decoration:none; color:var(--ink)}
.nav a{color:var(--muted); text-decoration:none; margin-left:18px}
.nav a:hover{color:var(--ink)}
.hero{background:linear-gradient(90deg, color-mix(in srgb,var(--accent) 12%, transparent), transparent 60%); border:1px solid var(--border); border-radius:14px; padding:22px 24px; margin-bottom:28px; box-shadow:var(--shadow)}
h1,h2,h3{margin:0 0 10px 0}
h1{font-size:28px; font-weight:800; letter-spacing:.2px}
h2{font-size:20px; margin-top:24px}
.sub{color:var(--muted); margin:.6rem 0 1.1rem}
.card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:22px 24px; margin-top:16px; box-shadow:var(--shadow)}
.grid{list-style:none; padding:0; margin:12px 0 24px; display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px}
.grid li{list-style:none}
.grid a.card{display:block; color:var(--ink); text-decoration:none; border:1px solid var(--border); border-radius:12px; padding:16px 18px; background:var(--panel); box-shadow:var(--shadow); transition:transform .15s ease, border-color .15s ease}
.grid a.card:hover{transform:translateY(-2px); border-color:var(--accent)}
.table{width:100%; border-collapse:separate; border-spacing:0; margin-top:12px}
.table thead th{background:color-mix(in srgb, var(--muted) 10%, transparent); color:var(--ink); text-align:left; font-weight:600; padding:12px; border-bottom:1px solid var(--border)}
.table tbody td{padding:12px; border-bottom:1px solid var(--border)}
.chip{display:inline-block; background:color-mix(in srgb, var(--muted) 12%, transparent); color:var(--ink); border:1px solid var(--border); padding:2px 8px; border-radius:999px}
code{background:color-mix(in srgb, var(--muted) 14%, transparent); padding:.15rem .4rem; border-radius:6px}
a{color:var(--accent); text-underline-offset:2px}
a.muted{color:var(--muted)}
a:focus-visible{outline:none; box-shadow:var(--ring)}
footer{border-top:1px solid var(--border); margin-top:36px}
footer .container{padding:18px 24px}
@media (max-width:720px){ .container{margin:40px auto; padding:0 16px} .site-head .container{padding:12px 16px} .grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))} }

--- END xslt/style.css ---
--- BEGIN scripts/build_index.sh ---
#!/usr/bin/env bash
set -euo pipefail
V="${1:-$EPOCHSECONDS}"
rm -rf site
mkdir -p site/cards
cp -f docs/style.css site/style.css
cp -f out/html/*.html site/cards/

# Build a single “cards” grid homepage
cat > site/index.html <<HTML
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FDML – Examples</title>
<link rel="stylesheet" href="style.css?v=${V}">
</head>
<body>
<header class="site-head">
  <div class="container">
    <a class="brand" href="./">FDML</a>
    <nav class="nav">
      <a href="./index.html">Home</a>
      <a class="muted" href="https://github.com/ShivsaranshThakur1-Coder/fdml-core">GitHub</a>
    </nav>
  </div>
</header>
<main class="container">
  <div class="hero">
    <h1>Folk Dance Markup Library</h1>
    <p class="sub">Curated, validated examples rendered as clean, printable cards.</p>
  </div>
  <ul class="grid">
HTML
for p in site/cards/*.html; do
  b="$(basename "$p")"
  title="$(grep -m1 -oE '<h1[^>]*>[^<]+' "$p" | sed -E 's#<[^>]+>##g')"
  printf '    <li><a class="card" href="cards/%s"><strong>%s</strong><div class="sub">%s</div></a></li>\n' "$b" "$title" "$b" >> site/index.html
done
cat >> site/index.html <<'HTML'
  </ul>
  <footer><div class="container">
    <span class="muted">©</span> <a class="muted" href="https://github.com/ShivsaranshThakur1-Coder">Shivsaransh Thakur</a> ·
    <a class="muted" href="https://github.com/ShivsaranshThakur1-Coder/fdml-core">Source</a>
  </div></footer>
</main>
</body></html>
HTML
echo "Site built → site/ (with cards/ and polished index)"

--- END scripts/build_index.sh ---
--- BEGIN scripts/gen_examples.sh ---
#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
OUT="$ROOT/docs/examples"
PDF="$ROOT/docs/pdfs"

rm -rf "$OUT"
mkdir -p "$OUT" "$ROOT/docs/css" "$PDF"

cp -f "$ROOT/css/print.css" "$ROOT/docs/css/print.css"

for f in "$ROOT"/corpus/valid/*.xml; do
  b="$(basename "$f")"
  name="${b%.*}"
  "$ROOT/bin/fdml" render "$f" --out "$OUT/$name.html"
  "$ROOT/bin/fdml" export-pdf "$f" --out "$PDF/$name.pdf" || true
done

cat > "$OUT/index.html" <<HTML
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>FDML Examples</title>
    <link rel="stylesheet" href="../site.css"/>
  </head>
  <body>
    <div class="wrap">
      <div class="nav"><a class="cta" href="../index.html">← Home</a></div>
      <h1>FDML Examples</h1>
      <ul>
HTML

for html in "$OUT"/*.html; do
  base="$(basename "$html")"
  title="$(sed -n 's@.*<title>\\(.*\\)</title>.*@\\1@p' "$html" | head -n1)"
  pdfbase="$(echo "$base" | sed 's/\.html$/.pdf/')"
  pdfrel="../pdfs/$pdfbase"
  if [ -f "$PDF/$pdfbase" ]; then
    echo "        <li><a href=\"$base\">${title:-$base}</a> — <a href=\"$pdfrel\">PDF</a></li>" >> "$OUT/index.html"
  else
    echo "        <li><a href=\"$base\">${title:-$base}</a></li>" >> "$OUT/index.html"
  fi
done

cat >> "$OUT/index.html" <<HTML
      </ul>
    </div>
  </body>
</html>
HTML

--- END scripts/gen_examples.sh ---
--- BEGIN scripts/local_sanity.sh ---
#!/usr/bin/env bash
set -euo pipefail
echo "== fdml version =="; fdml --help | head -n 3
echo "== make ci =="; make -s ci
echo "== make json =="; make -s json; ls -1 out/json | wc -l
echo "== make html =="; make -s html; ls -1 out/html | wc -l
rm -f /tmp/smoke.fdml.xml
fdml init /tmp/smoke.fdml.xml --title "Smoke" --meter 3/4 --tempo 96 --figure-id f-1 --figure-name Intro
fdml validate /tmp/smoke.fdml.xml
echo "OK"

--- END scripts/local_sanity.sh ---
--- BEGIN scripts/ci_debug.sh ---
#!/usr/bin/env bash
set -euo pipefail
RUN_JSON=$(gh run list --workflow CI -L 1 --json databaseId,headSha,headBranch,conclusion,startedAt,updatedAt -q '.[0]')
echo "RUN=$RUN_JSON"
RUN_ID=$(echo "$RUN_JSON" | sed -n 's/.*"databaseId":[ ]*\([0-9]*\).*/\1/p')
echo "RUN_ID=$RUN_ID"
echo "JOBS:"
gh run view "$RUN_ID" --json jobs -q '.jobs[] | "\(.databaseId)\t\(.name)\t\(.conclusion)"'
FAIL_ID=$(gh run view "$RUN_ID" --json jobs -q '.jobs[] | select(.conclusion=="failure") | .databaseId' | head -n1)
if [ -z "${FAIL_ID:-}" ]; then
  JOB_ID=$(gh run view "$RUN_ID" --json jobs -q '.jobs[] | select(.name=="build") | .databaseId' | head -n1)
else
  JOB_ID="$FAIL_ID"
fi
echo "JOB_ID=$JOB_ID"
echo "----- LOG TAIL -----"
gh run view "$RUN_ID" --job "$JOB_ID" --log | tail -n 300
echo "----- ERROR GREP -----"
OUTDIR="out/ci-logs-$RUN_ID"
mkdir -p "$OUTDIR"
set +e
gh run download "$RUN_ID" -D "$OUTDIR" >/dev/null 2>&1
set -e
if compgen -G "$OUTDIR/**/*.txt" > /dev/null 2>&1; then
  find "$OUTDIR" -type f -name '*.txt' -maxdepth 3 -print
  grep -RInE "##\\[error\\]|FAIL|SCH FAIL|cvc-|XPST0003|SXXP0003|COMPILATION ERROR" "$OUTDIR" | tail -n 120 || true
else
  echo "No artifacts to download"
fi
echo "----- CI SHA VS LOCAL -----"
SHA=$(gh run view "$RUN_ID" --json headSha -q '.headSha'); echo "CI_SHA=$SHA"
git fetch origin >/dev/null 2>&1 || true
echo "HEAD=$(git rev-parse HEAD)"
git diff --name-status "$SHA"..HEAD || true

--- END scripts/ci_debug.sh ---
--- BEGIN scripts/ci_diff.sh ---
#!/usr/bin/env bash
set -euo pipefail
RID=$(gh run list --workflow CI -L 1 --json databaseId -q '.[0].databaseId')
SHA=$(gh run view "$RID" --json headSha -q '.headSha')
echo "CI_SHA=$SHA"
git fetch origin
echo "HEAD=$(git rev-parse HEAD)"
git diff --name-status "$SHA"..HEAD || true

--- END scripts/ci_diff.sh ---
--- BEGIN scripts/ci_latest.sh ---
#!/usr/bin/env bash
set -euo pipefail
RUN=$(gh run list --workflow CI -L 1 --json databaseId,headSha,headBranch,conclusion,startedAt,updatedAt -q '.[0]')
echo "$RUN"
RID=$(echo "$RUN" | sed -n 's/.*"databaseId":[ ]*\([0-9]*\).*/\1/p')
echo "RUN_ID=$RID"
gh run view "$RID" --json jobs -q '.jobs[] | "\(.databaseId)\t\(.name)\t\(.conclusion)"'

--- END scripts/ci_latest.sh ---
--- BEGIN bin/fdml ---
#!/usr/bin/env bash
set -euo pipefail
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"
JAR="$DIR/target/fdml-core.jar"
if [[ ! -f "$JAR" ]]; then
  echo "Building fdml-core.jar..."
  (cd "$DIR" && mvn -q -DskipTests package)
fi
exec java -jar "$JAR" "$@"

--- END bin/fdml ---
--- BEGIN site/index.html ---
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FDML – Examples</title>
<link rel="stylesheet" href="style.css?v=1761576811">
</head>
<body>
<header class="site-head">
  <div class="container">
    <a class="brand" href="./">FDML</a>
    <nav class="nav">
      <a href="./index.html">Home</a>
      <a class="muted" href="https://github.com/ShivsaranshThakur1-Coder/fdml-core">GitHub</a>
    </nav>
  </div>
</header>
<main class="container">
  <div class="hero">
    <h1>Folk Dance Markup Library</h1>
    <p class="sub">Curated, validated examples rendered as clean, printable cards.</p>
  </div>
  <ul class="grid">
    <li><a class="card" href="cards/example-01.fdml.html"><strong>Example Valid FDML</strong><div class="sub">example-01.fdml.html</div></a></li>
    <li><a class="card" href="cards/example-02.fdml.html"><strong>Valid FDML with sections</strong><div class="sub">example-02.fdml.html</div></a></li>
    <li><a class="card" href="cards/example-03.fdml.html"><strong>Circle Waltz — Basic</strong><div class="sub">example-03.fdml.html</div></a></li>
    <li><a class="card" href="cards/example-04.fdml.html"><strong>Circle Waltz — Teaching Set</strong><div class="sub">example-04.fdml.html</div></a></li>
    <li><a class="card" href="cards/example-05-contra.fdml.html"><strong>Contra — Longways Set</strong><div class="sub">example-05-contra.fdml.html</div></a></li>
    <li><a class="card" href="cards/example-06-square.fdml.html"><strong>Square — Right &amp; Left Thru</strong><div class="sub">example-06-square.fdml.html</div></a></li>
    <li><a class="card" href="cards/example-07-mixer.fdml.html"><strong>Circle Mixer — Intro</strong><div class="sub">example-07-mixer.fdml.html</div></a></li>
    <li><a class="card" href="cards/example-08-init.fdml.html"><strong>Demo Init</strong><div class="sub">example-08-init.fdml.html</div></a></li>
  </ul>
  <footer><div class="container">
    <span class="muted">©</span> <a class="muted" href="https://github.com/ShivsaranshThakur1-Coder">Shivsaransh Thakur</a> ·
    <a class="muted" href="https://github.com/ShivsaranshThakur1-Coder/fdml-core">Source</a>
  </div></footer>
</main>
</body></html>

--- END site/index.html ---
--- BEGIN docs/style.css ---
:root{
  --bg:#0b1020; --panel:#0f172a; --ink:#e6edf3; --muted:#a4b1c3; --accent:#22c55e; --accent-ink:#062d16; --border:#1f2937; --ring:0 0 0 3px rgba(34,197,94,.25);
  --shadow:0 2px 10px rgba(2,6,23,.35), 0 1px 0 rgba(255,255,255,.02) inset
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f6f8fa; --panel:#ffffff; --ink:#0f172a; --muted:#475569; --accent:#2563eb; --accent-ink:#0b3a72; --border:#e5e7eb; --shadow:0 2px 12px rgba(2,6,23,.06) }
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:15.5px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
  color:var(--ink); background:var(--bg);
}
.container{max-width:1120px; margin:56px auto; padding:0 24px}
.site-head{position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(10px); background:color-mix(in hsl, var(--bg) 88%, transparent); border-bottom:1px solid var(--border)}
.site-head .container{display:flex; align-items:center; justify-content:space-between; padding:14px 24px}
.brand{font-weight:800; letter-spacing:.2px; color:var(--ink); text-decoration:none}
.nav a{color:var(--muted); text-decoration:none; margin-left:18px}
.nav a:hover{color:var(--ink)}
.hero{background:linear-gradient(90deg, color-mix(in srgb, var(--accent) 12%, transparent), transparent); border:1px solid var(--border); border-radius:14px; padding:22px 24px; margin:0 0 28px 0; box-shadow:var(--shadow)}
h1,h2,h3{margin:0 0 10px}
h1{font-size:28px; font-weight:800; letter-spacing:.2px}
h2{font-size:20px}
.sub{color:var(--muted); margin:.6rem 0 1.1rem}
.card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:18px 20px; box-shadow:var(--shadow)}
.grid{list-style:none; padding:0; margin:12px 0 24px; display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:14px}
.grid a{display:block; color:var(--ink); text-decoration:none; border:1px solid var(--border); border-radius:12px; padding:16px 18px; background:var(--panel); box-shadow:var(--shadow); transition:transform .15s ease, box-shadow .15s ease}
.grid a:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(2,6,23,.35)}
.table{width:100%; border-collapse:separate; border-spacing:0; margin-top:12px}
.table thead th{background:color-mix(in srgb, var(--muted) 12%, transparent); color:var(--ink); text-align:left; font-weight:600; padding:12px; border-bottom:1px solid var(--border)}
.table tbody td{padding:12px; border-bottom:1px solid var(--border)}
.chip{display:inline-block; background:color-mix(in srgb, var(--muted) 12%, transparent); color:var(--ink); border:1px solid var(--border); padding:2px 8px; border-radius:999px}
code{background:color-mix(in srgb, var(--muted) 14%, transparent); padding:.15rem .4rem; border-radius:6px}
a{color:var(--accent); text-underline-offset:2px}
a.muted{color:var(--muted)}
a:focus-visible{outline:none; box-shadow:var(--ring)}
footer{border-top:1px solid var(--border); margin-top:36px}
footer .container{padding:18px 24px}
@media (max-width:720px){ .container{margin:40px auto; padding:0 16px} .site-head .container{padding:12px 16px} .grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))} }

--- END docs/style.css ---
--- BEGIN docs/site.css ---
:root{--bg:#0b0f14;--card:#121821;--ink:#eef2f7;--muted:#94a3b8;--link:#59a6ff;--accent:#3b82f6}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif}
.wrap{max-width:1000px;margin:0 auto;padding:48px 20px}
.nav{display:flex;gap:16px;margin:16px 0 28px 0}
a{color:var(--link);text-decoration:none}a:hover{text-decoration:underline}
.hero{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;font-size:28px}
.muted{color:var(--muted)}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
.card{background:var(--card);border:1px solid #1f2632;border-radius:12px;padding:16px;box-shadow:0 0 0 1px rgba(255,255,255,0.02) inset}
.card h3{margin:0 0 6px 0;font-size:18px}
.card p{margin:0;color:var(--muted)}
.cta{display:inline-block;margin-top:12px;padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff;text-decoration:none}

--- END docs/site.css ---
--- BEGIN css/print.css ---
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 2rem; }
.fdml { display: grid; gap: 1rem; }
.meta .title { font-size: 1.4rem; font-weight: 600; margin-bottom: 0.25rem; }
.figure-card { border: 1px solid #ddd; padding: 1rem; border-radius: 8px; }
.figure-card h2 { margin: 0 0 0.5rem 0; font-size: 1.1rem; display: flex; gap: .5rem; align-items: baseline; }
.figure-card h2 .beats { font-weight: 400; font-size: .95rem; opacity: .85; }
.steps { width: 100%; border-collapse: collapse; font-size: .95rem; }
.steps th, .steps td { border: 1px solid #eee; padding: .35rem .5rem; text-align: left; }
.dir { vertical-align: middle; margin-left: .15rem; }
.dir path, .dir line { stroke: currentColor; fill: currentColor; stroke-width: 2; }
.dir-uni { margin-left: .15rem; }
@media print {
  body { margin: 0.5in; }
  .figure-card { page-break-inside: avoid; }
}

--- END css/print.css ---

## Java sources (full text)
--- BEGIN src/main/java/org/fdml/cli/Doctor.java ---
package org.fdml.cli;

import java.nio.file.*;
import java.util.*;

class Doctor {
  static int run(String[] args) {
    boolean json   = hasFlag(args, "--json");
    boolean strict = hasFlag(args, "--strict");
    List<Path> targets = collectNonFlagPaths(args, 1);
    if (targets.isEmpty()) {
      System.err.println("doctor: provide <file-or-dir> [--json] [--strict]");
      return 4;
    }
    Path schemaPath = Paths.get("schema/fdml.xsd");
    FdmlValidator v = new FdmlValidator(schemaPath);
    SchematronValidator s = new SchematronValidator(Paths.get("schematron/fdml-compiled.xsl"));
    var rX = v.validateCollect(targets);
    var rS = s.validateCollect(targets);
    var rL = Linter.lintCollect(targets);

    boolean okX = allOkX(rX);
    boolean okS = allOkS(rS);
    boolean okL = allOkL(rL);

    if (json) {
      System.out.println(MainJson.toJsonDoctor(rX, rS, rL));
    } else {
      System.out.println("DOCTOR SUMMARY");
      System.out.println("  XSD       : " + (okX ? "OK" : "FAILED"));
      System.out.println("  Schematron: " + (okS ? "OK" : "FAILED"));
      long warns = rL.stream().filter(fr -> !fr.ok()).count();
      System.out.println("  Lint      : " + (warns == 0 ? "OK" : (warns + " file(s) with warnings")));
    }
    if (strict) {
      if (!okX || !okS || !okL) return 2;
    }
    return 0;
  }

  private static boolean hasFlag(String[] a, String f){ for (String s : a) if (f.equals(s)) return true; return false; }
  private static List<Path> collectNonFlagPaths(String[] args, int from) {
    List<Path> t = new ArrayList<>();
    for (int i = from; i < args.length; i++) if (!args[i].startsWith("--")) t.add(Paths.get(args[i]));
    return t;
  }
  private static boolean allOkX(java.util.List<FdmlValidator.Result> xs){ for (var r: xs) if(!r.ok) return false; return true; }
  private static boolean allOkS(java.util.List<SchematronValidator.Result> xs){ for (var r: xs) if(!r.ok) return false; return true; }
  private static boolean allOkL(java.util.List<Linter.FileResult> xs){ for (var r: xs) if(!r.ok()) return false; return true; }
}

--- END src/main/java/org/fdml/cli/Doctor.java ---
--- BEGIN src/main/java/org/fdml/cli/FdmlValidator.java ---
package org.fdml.cli;

import javax.xml.XMLConstants;
import javax.xml.transform.stream.StreamSource;
import javax.xml.validation.*;
import org.xml.sax.SAXException;
import org.xml.sax.SAXParseException;

import java.io.IOException;
import java.nio.file.*;
import java.util.*;

class FdmlValidator {

  static class Result {
    final Path file;
    final boolean ok;
    final String message;
    final Integer line;
    final Integer column;
    Result(Path file, boolean ok, String message, Integer line, Integer column) {
      this.file = file;
      this.ok = ok;
      this.message = message;
      this.line = line;
      this.column = column;
    }
  }

  private final Schema schema;

  FdmlValidator(Path xsdPath) {
    try {
      SchemaFactory sf = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
      this.schema = sf.newSchema(xsdPath.toFile());
    } catch (SAXException e) {
      throw new RuntimeException("Failed to load schema: " + xsdPath, e);
    }
  }

  List<Result> validateCollect(List<Path> inputs) {
    List<Path> files = expandAll(inputs);
    List<Result> out = new ArrayList<>();
    for (Path f : files) out.add(validateOne(f));
    return out;
  }

  boolean validatePaths(List<Path> inputs) {
    List<Result> results = validateCollect(inputs);
    boolean allOk = true;
    for (Result r : results) {
      if (r.ok) System.out.println("OK  : " + r.file);
      else System.out.println("FAIL: " + r.file + (r.message != null ? " : " + r.message : ""));
      allOk &= r.ok;
    }
    System.out.printf("Validated %d file(s).%n", results.size());
    return allOk;
  }

  private Result validateOne(Path f) {
    try {
      Validator v = schema.newValidator();
      v.validate(new StreamSource(f.toFile()));
      return new Result(f, true, null, null, null);
    } catch (SAXParseException e) {
      String msg = String.format("(line %d, col %d): %s", e.getLineNumber(), e.getColumnNumber(), e.getMessage());
      return new Result(f, false, msg, e.getLineNumber(), e.getColumnNumber());
    } catch (SAXException | IOException e) {
      return new Result(f, false, e.getMessage(), null, null);
    }
  }

  private List<Path> expandAll(List<Path> inputs) {
    List<Path> files = new ArrayList<>();
    for (Path p : inputs) {
      if (Files.isDirectory(p)) {
        try {
          Files.walk(p).filter(Files::isRegularFile).filter(this::looksLikeXml).forEach(files::add);
        } catch (IOException e) { throw new RuntimeException(e); }
      } else {
        files.add(p);
      }
    }
    return files;
  }

  private boolean looksLikeXml(Path p) {
    String n = p.getFileName().toString().toLowerCase();
    return n.endsWith(".xml") || n.endsWith(".fdml") || n.endsWith(".fdml.xml");
  }
}

--- END src/main/java/org/fdml/cli/FdmlValidator.java ---
--- BEGIN src/main/java/org/fdml/cli/Indexer.java ---
package org.fdml.cli;

import net.sf.saxon.s9api.*;
import javax.xml.transform.stream.StreamSource;
import java.nio.file.*;
import java.util.*;

class Indexer {
  static String buildIndex(List<Path> inputs) {
    try {
      Processor proc = new Processor(false);
      DocumentBuilder db = proc.newDocumentBuilder();
      XPathCompiler xpc = proc.newXPathCompiler();

      List<Path> files = expandAll(inputs);
      StringBuilder sb = new StringBuilder();
      sb.append("{\"items\":[");
      for (int i = 0; i < files.size(); i++) {
        Path f = files.get(i);

        // Parse XML; keep going even if one file is bad
        XdmNode doc;
        try {
          doc = db.build(new StreamSource(f.toFile()));
        } catch (SaxonApiException e) {
          sb.append("{\"file\":\"").append(esc(f.toString()))
            .append("\",\"error\":\"").append(esc(e.getMessage())).append("\"}");
          if (i < files.size() - 1) sb.append(",");
          continue;
        }

        String title = evalString(xpc, doc, "normalize-space(/fdml/meta/title)");
        String email = evalString(xpc, doc, "normalize-space(/fdml/meta/author/@email)");

        XdmValue secVals = eval(xpc, doc, "/fdml/body/section/@id/string()");
        List<String> sections = new ArrayList<>();
        if (secVals != null) for (XdmItem it : secVals) sections.add(it.getStringValue());

        sb.append("{\"file\":\"").append(esc(f.toString())).append("\"");
        if (!isEmpty(title)) sb.append(",\"title\":\"").append(esc(title)).append("\"");
        if (!isEmpty(email)) sb.append(",\"authorEmail\":\"").append(esc(email)).append("\"");
        sb.append(",\"sections\":[");
        for (int j = 0; j < sections.size(); j++) {
          sb.append("\"").append(esc(sections.get(j))).append("\"");
          if (j < sections.size() - 1) sb.append(",");
        }
        sb.append("]}");
        if (i < files.size() - 1) sb.append(",");
      }
      sb.append("]}");
      return sb.toString();
    } catch (Exception e) {
      throw new RuntimeException("Indexing failed: " + e.getMessage(), e);
    }
  }

  private static XdmValue eval(XPathCompiler xpc, XdmNode doc, String expr) {
    try { return xpc.evaluate(expr, doc); }
    catch (SaxonApiException e) { return null; }
  }

  private static String evalString(XPathCompiler xpc, XdmNode doc, String expr) {
    try {
      XdmItem item = xpc.evaluateSingle(expr, doc); // safe, no checked XPathException downstream
      return item == null ? "" : item.getStringValue();
    } catch (SaxonApiException e) {
      return "";
    }
  }

  private static List<Path> expandAll(List<Path> inputs) {
    List<Path> out = new ArrayList<>();
    for (Path p : inputs) {
      try {
        if (Files.isDirectory(p)) Files.walk(p).filter(Files::isRegularFile).forEach(out::add);
        else out.add(p);
      } catch (Exception e) { throw new RuntimeException(e); }
    }
    return out;
  }

  private static boolean isEmpty(String s) { return s == null || s.trim().isEmpty(); }
  private static String esc(String s) { return s.replace("\\","\\\\").replace("\"","\\\"").replace("\n","\\n").replace("\r",""); }
}

--- END src/main/java/org/fdml/cli/Indexer.java ---
--- BEGIN src/main/java/org/fdml/cli/Init.java ---
package org.fdml.cli;

import java.nio.file.*;
import java.nio.charset.StandardCharsets;
import java.util.*;

class Init {
  static void run(String[] args) {
    if (args.length < 2) {
      System.err.println("init: provide <output-file> [--title T] [--dance D] [--meter M/N] [--tempo BPM] [--figure-id f-...] [--figure-name NAME] [--formation FORM]");
      System.exit(4);
    }
    Path out = Paths.get(args[1]);
    Map<String,String> kv = parseFlags(args, 2);

    String title       = kv.getOrDefault("--title", "Untitled Routine");
    String dance       = kv.getOrDefault("--dance", "");
    String meter       = kv.getOrDefault("--meter", "4/4");
    String tempo       = kv.getOrDefault("--tempo", "112");
    String figId       = kv.getOrDefault("--figure-id", "f-basic");
    String figName     = kv.getOrDefault("--figure-name", "Basic Step");
    String formation   = kv.getOrDefault("--formation", "circle");

    StringBuilder sb = new StringBuilder();
    sb.append("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n");
    sb.append("<fdml version=\"1.0\">\n");
    sb.append("  <meta>\n");
    sb.append("    <title>").append(escape(title)).append("</title>\n");
    if (!dance.isBlank()) sb.append("    <dance name=\"").append(escape(dance)).append("\"/>\n");
    sb.append("    <meter value=\"").append(escape(meter)).append("\"/>\n");
    sb.append("    <tempo bpm=\"").append(escape(tempo)).append("\"/>\n");
    sb.append("  </meta>\n");
    sb.append("  <body>\n");
    sb.append("    <figure id=\"").append(escape(figId)).append("\" name=\"").append(escape(figName)).append("\" formation=\"").append(escape(formation)).append("\">\n");
    sb.append("      <step who=\"both\" action=\"Step L\" beats=\"1\" count=\"1\" startFoot=\"L\">Weight to L</step>\n");
    sb.append("      <step who=\"both\" action=\"Close R\" beats=\"1\" count=\"2\" startFoot=\"R\" endFoot=\"B\">Close R to L</step>\n");
    sb.append("      <step who=\"both\" action=\"Step L\" beats=\"1\" count=\"3\" startFoot=\"L\">Weight to L</step>\n");
    sb.append("    </figure>\n");
    sb.append("  </body>\n");
    sb.append("</fdml>\n");

    try {
      Files.createDirectories(out.getParent() == null ? Paths.get(".") : out.getParent());
      Files.writeString(out, sb.toString(), StandardCharsets.UTF_8, StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING);
      System.out.println("Created: " + out);
    } catch (Exception e) {
      e.printStackTrace();
      System.exit(4);
    }
  }

  private static Map<String,String> parseFlags(String[] args, int from) {
    Map<String,String> m = new HashMap<>();
    for (int i = from; i < args.length; i++) {
      String a = args[i];
      if (a.startsWith("--")) {
        String val = "";
        if (i+1 < args.length && !args[i+1].startsWith("--")) { val = args[++i]; }
        m.put(a, val);
      }
    }
    return m;
  }

  private static String escape(String s) {
    return s.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")
            .replace("\"","&quot;").replace("'","&apos;");
  }
}

--- END src/main/java/org/fdml/cli/Init.java ---
--- BEGIN src/main/java/org/fdml/cli/Linter.java ---
package org.fdml.cli;

import net.sf.saxon.s9api.*;
import javax.xml.transform.stream.StreamSource;
import java.nio.file.*;
import java.util.*;

class Linter {

  static final class Warning {
    final String code;
    final String figureId;
    final String meter;
    final long beats;
    final String bars;
    final String message;
    Warning(String code, String figureId, String meter, long beats, String bars, String message) {
      this.code = code; this.figureId = figureId; this.meter = meter; this.beats = beats; this.bars = bars; this.message = message;
    }
  }

  static final class FileResult {
    final Path file;
    final List<Warning> warnings = new ArrayList<>();
    FileResult(Path f) { this.file = f; }
    boolean ok() { return warnings.isEmpty(); }
  }

  static List<FileResult> lintCollect(List<Path> inputs) {
    List<Path> files = expandAll(inputs);
    List<FileResult> out = new ArrayList<>();
    try {
      Processor proc = new Processor(false);
      DocumentBuilder db = proc.newDocumentBuilder();
      XPathCompiler xpc = proc.newXPathCompiler();

      for (Path f : files) {
        FileResult r = new FileResult(f);
        XdmNode doc;
        try {
          doc = db.build(new StreamSource(f.toFile()));
        } catch (SaxonApiException e) {
          r.warnings.add(new Warning("parse_error", null, null, 0, null, e.getMessage()));
          out.add(r);
          continue;
        }

        String meter = string(xpc, "normalize-space(/fdml/meta/meter/@value)", doc);
        Integer num = parseMeterNumerator(meter);

        XdmValue figures = eval(xpc, "/fdml/body/figure", doc);
        for (XdmItem it : figures) {
          XdmNode fig = (XdmNode) it;
          String figId = string(xpc, "string(@id)", fig);
          long beats = roundToLong(evalNumber(xpc, "number(sum(./step/@beats))", fig));
          if (num != null && num > 0) {
            long rem = beats % num;
            if (rem != 0) {
              double bars = (num == 0) ? 0.0 : (beats * 1.0 / num);
              r.warnings.add(new Warning(
                "off_meter",
                figId == null || figId.isEmpty() ? "(no-id)" : figId,
                meter,
                beats,
                String.format(java.util.Locale.ROOT, "%.2f", bars),
                "total beats not divisible by meter numerator"
              ));
            }
          }
        }

        if (meter == null || meter.isEmpty()) {
          r.warnings.add(new Warning("missing_meter", null, null, 0, null, "meta/meter/@value is missing"));
        }

        out.add(r);
      }
    } catch (Exception e) {
      throw new RuntimeException(e);
    }
    return out;
  }

  private static List<Path> expandAll(List<Path> inputs) {
    List<Path> out = new ArrayList<>();
    for (Path p : inputs) {
      try {
        if (Files.isDirectory(p)) Files.walk(p).filter(Files::isRegularFile).forEach(out::add);
        else out.add(p);
      } catch (Exception e) { throw new RuntimeException(e); }
    }
    return out;
  }

  private static String string(XPathCompiler xpc, String expr, XdmNode node) {
    try { XdmItem i = xpc.evaluateSingle(expr, node); return i == null ? "" : i.getStringValue(); }
    catch (SaxonApiException e) { return ""; }
  }

  private static double evalNumber(XPathCompiler xpc, String expr, XdmNode node) {
    try { XdmItem i = xpc.evaluateSingle(expr, node); return i == null ? Double.NaN : Double.parseDouble(i.getStringValue()); }
    catch (Exception e) { return Double.NaN; }
  }

  private static long roundToLong(double d) {
    if (Double.isNaN(d) || Double.isInfinite(d)) return 0L;
    return Math.round(d);
  }

  private static Integer parseMeterNumerator(String meter) {
    if (meter == null) return null;
    int idx = meter.indexOf('/');
    if (idx <= 0) return null;
    try { return Integer.parseInt(meter.substring(0, idx).trim()); }
    catch (NumberFormatException e) { return null; }
  }

  private static XdmValue eval(XPathCompiler xpc, String expr, XdmNode node) {
    try { return xpc.evaluate(expr, node); }
    catch (SaxonApiException e) { return XdmEmptySequence.getInstance(); }
  }

  private static XdmValue eval(XPathCompiler xpc, XdmNode node, String expr) {
    try { return xpc.evaluate(expr, node); }
    catch (SaxonApiException e) { return XdmEmptySequence.getInstance(); }
  }
}

--- END src/main/java/org/fdml/cli/Linter.java ---
--- BEGIN src/main/java/org/fdml/cli/Main.java ---
package org.fdml.cli;

import java.nio.file.*;
import java.nio.charset.StandardCharsets;
import java.util.*;

public class Main {
  private static final int EXIT_OK = 0;
  private static final int EXIT_VALIDATION_ERR = 2;
  private static final int EXIT_TRANSFORM_ERR = 3;
  private static final int EXIT_IO_ERR = 4;

  public static void main(String[] args) {
    if (args.length < 1) { usage(); System.exit(EXIT_IO_ERR); }
    String cmd = args[0];
    try {
      switch (cmd) {
        case "validate": {
          boolean json = hasFlag(args, "--json");
          String jsonOut = flagValue(args, "--json-out");
          List<Path> targets = collectNonFlagPaths(args, 1);
          if (targets.isEmpty()) { System.err.println("validate: provide at least one file or directory"); System.exit(EXIT_IO_ERR); }
          Path schemaPath = Paths.get("schema/fdml.xsd");
          FdmlValidator v = new FdmlValidator(schemaPath);
          if (json || jsonOut != null) {
            var r = v.validateCollect(targets);
            String payload = toJsonValidate(r);
            System.out.println(payload);
            if (jsonOut != null) Files.writeString(Paths.get(jsonOut), payload, StandardCharsets.UTF_8);
            System.exit(allOk(r) ? EXIT_OK : EXIT_VALIDATION_ERR);
          } else {
            boolean ok = v.validatePaths(targets);
            System.exit(ok ? EXIT_OK : EXIT_VALIDATION_ERR);
          }
        }

        case "validate-sch": {
          boolean json = hasFlag(args, "--json");
          String jsonOut = flagValue(args, "--json-out");
          List<Path> targets = collectNonFlagPaths(args, 1);
          if (targets.isEmpty()) { System.err.println("validate-sch: provide at least one file or directory"); System.exit(EXIT_IO_ERR); }
          Path schXsl = Paths.get("schematron/fdml-compiled.xsl");
          SchematronValidator sch = new SchematronValidator(schXsl);
          if (json || jsonOut != null) {
            var r = sch.validateCollect(targets);
            String payload = toJsonValidateSch(r);
            System.out.println(payload);
            if (jsonOut != null) Files.writeString(Paths.get(jsonOut), payload, StandardCharsets.UTF_8);
            System.exit(allOkSch(r) ? EXIT_OK : EXIT_VALIDATION_ERR);
          } else {
            boolean ok = sch.validatePaths(targets);
            System.exit(ok ? EXIT_OK : EXIT_VALIDATION_ERR);
          }
        }

        case "validate-all": {
          boolean json = hasFlag(args, "--json");
          String jsonOut = flagValue(args, "--json-out");
          List<Path> targets = collectNonFlagPaths(args, 1);
          if (targets.isEmpty()) { System.err.println("validate-all: provide at least one file or directory"); System.exit(EXIT_IO_ERR); }
          Path schemaPath = Paths.get("schema/fdml.xsd");
          FdmlValidator v = new FdmlValidator(schemaPath);
          Path schXsl = Paths.get("schematron/fdml-compiled.xsl");
          SchematronValidator sch = new SchematronValidator(schXsl);
          if (json || jsonOut != null) {
            var r1 = v.validateCollect(targets);
            var r2 = sch.validateCollect(targets);
            String payload = toJsonValidateAll(r1, r2);
            System.out.println(payload);
            if (jsonOut != null) Files.writeString(Paths.get(jsonOut), payload, StandardCharsets.UTF_8);
            System.exit(allOk(r1) && allOkSch(r2) ? EXIT_OK : EXIT_VALIDATION_ERR);
          } else {
            boolean ok1 = v.validatePaths(targets);
            boolean ok2 = sch.validatePaths(targets);
            System.exit(ok1 && ok2 ? EXIT_OK : EXIT_VALIDATION_ERR);
          }
        }

        case "render": {
          List<String> rest = new ArrayList<>();
          Path out = Paths.get("out/render.html");
          for (int i = 1; i < args.length; i++) {
            if ("--out".equals(args[i]) && i + 1 < args.length) out = Paths.get(args[++i]);
            else rest.add(args[i]);
          }
          if (rest.isEmpty()) { System.err.println("render: provide <fdml-file> [--out path]"); System.exit(EXIT_IO_ERR); }
          Path in  = Paths.get(rest.get(0));
          Path xsl = Paths.get("xslt/fdml-to-card.xsl");
          Renderer.render(in, xsl, out);
          System.exit(EXIT_OK);
        }

        case "export-pdf": {
          List<String> rest = new ArrayList<>();
          Path out = Paths.get("out/export.pdf");
          for (int i = 1; i < args.length; i++) {
            if ("--out".equals(args[i]) && i + 1 < args.length) out = Paths.get(args[++i]);
            else rest.add(args[i]);
          }
          if (rest.isEmpty()) { System.err.println("export-pdf: provide <fdml-file> [--out out.pdf]"); System.exit(EXIT_IO_ERR); }
          Path in  = Paths.get(rest.get(0));
          Path xsl = Paths.get("xslt/fdml-to-xhtml.xsl");
          Path examplesDir = Paths.get("docs/examples");
          PdfExporter.export(in, xsl, examplesDir, out);
          System.exit(EXIT_OK);
        }

        case "index": {
          List<String> rest = new ArrayList<>();
          Path out = Paths.get("out/index.json");
          for (int i = 1; i < args.length; i++) {
            if ("--out".equals(args[i]) && i + 1 < args.length) out = Paths.get(args[++i]);
            else rest.add(args[i]);
          }
          if (rest.isEmpty()) { System.err.println("index: provide <file-or-dir> [more...] [--out path]"); System.exit(EXIT_IO_ERR); }
          List<Path> targets = new ArrayList<>();
          for (String r : rest) targets.add(Paths.get(r));
          String payload = Indexer.buildIndex(targets);
          System.out.println(payload);
          try { Files.createDirectories(out.getParent()); } catch (Exception ignored) {}
          Files.writeString(out, payload, StandardCharsets.UTF_8);
          System.exit(EXIT_OK);
        }

        case "lint": {
          boolean json = hasFlag(args, "--json");
          String jsonOut = flagValue(args, "--json-out");
          boolean strict = hasFlag(args, "--strict");
          List<Path> targets = collectNonFlagPaths(args, 1);
          if (targets.isEmpty()) { System.err.println("lint: provide at least one file or directory"); System.exit(EXIT_IO_ERR); }
          var rs = Linter.lintCollect(targets);
          if (json || jsonOut != null) {
            String payload = toJsonLint(rs);
            System.out.println(payload);
            if (jsonOut != null) Files.writeString(Paths.get(jsonOut), payload, StandardCharsets.UTF_8);
          } else {
            for (var r : rs) {
              if (r.ok()) System.out.println("LINT OK : " + r.file);
              else {
                System.out.println("LINT WARN: " + r.file + " (" + r.warnings.size() + " warning(s))");
                for (var w : r.warnings) {
                  System.out.println("  → [" + w.code + "] figure=" + String.valueOf(w.figureId) +
                                     " beats=" + w.beats +
                                     (w.meter == null ? "" : " meter=" + w.meter) +
                                     (w.bars == null ? "" : " bars≈" + w.bars) +
                                     " : " + w.message);
                }
              }
            }
          }
          boolean anyWarn = false; for (var r : rs) if (!r.ok()) { anyWarn = true; break; }
          if (strict && anyWarn) System.exit(EXIT_VALIDATION_ERR);
          System.exit(EXIT_OK);
        }

        case "init": { Init.run(args); System.exit(EXIT_OK); }
        case "doctor": { int code = Doctor.run(args); System.exit(code); }

        default: { usage(); System.exit(EXIT_IO_ERR); }
      }
    } catch (Exception e) {
      e.printStackTrace();
      System.exit(EXIT_IO_ERR);
    }
  }

  private static boolean hasFlag(String[] args, String flag) {
    for (String a : args) if (flag.equals(a)) return true;
    return false;
  }
  private static String flagValue(String[] args, String flag) {
    for (int i = 0; i < args.length - 1; i++) if (flag.equals(args[i])) return args[i+1];
    return null;
  }
  private static List<Path> collectNonFlagPaths(String[] args, int from) {
    List<Path> t = new ArrayList<>();
    for (int i = from; i < args.length; i++) {
      String a = args[i];
      if (a.startsWith("--")) { if ("--out".equals(a) || "--json-out".equals(a)) i++; continue; }
      t.add(Paths.get(a));
    }
    return t;
  }

  // ---- helpers restored ----
  private static boolean allOk(java.util.List<FdmlValidator.Result> xs) {
    for (var r : xs) if (!r.ok) return false; return true;
  }
  private static boolean allOkSch(java.util.List<SchematronValidator.Result> xs) {
    for (var r : xs) if (!r.ok) return false; return true;
  }
  private static String esc(String s) {
    if (s == null) return null;
    return s.replace("\\","\\\\").replace("\"","\\\"").replace("\n","\\n").replace("\r","");
  }
  private static String toJsonValidate(java.util.List<FdmlValidator.Result> rs) {
    StringBuilder sb = new StringBuilder();
    sb.append("{\"command\":\"validate\",\"results\":[");
    for (int i=0;i<rs.size();i++) {
      var r = rs.get(i);
      sb.append("{\"file\":\"").append(esc(r.file.toString())).append("\",\"ok\":").append(r.ok);
      if (!r.ok) {
        if (r.message != null) sb.append(",\"error\":\"").append(esc(r.message)).append("\"");
        if (r.line != null) sb.append(",\"line\":").append(r.line);
        if (r.column != null) sb.append(",\"column\":").append(r.column);
      }
      sb.append("}");
      if (i < rs.size()-1) sb.append(",");
    }
    sb.append("]}");
    return sb.toString();
  }
  private static String toJsonValidateSch(java.util.List<SchematronValidator.Result> rs) {
    StringBuilder sb = new StringBuilder();
    sb.append("{\"command\":\"validate-sch\",\"results\":[");
    for (int i=0;i<rs.size();i++) {
      var r = rs.get(i);
      sb.append("{\"file\":\"").append(esc(r.file.toString())).append("\",\"ok\":").append(r.ok)
        .append(",\"failures\":").append(r.failures).append(",\"messages\":[");
      for (int j=0;j<r.messages.size();j++) {
        sb.append("\"").append(esc(r.messages.get(j))).append("\"");
        if (j<r.messages.size()-1) sb.append(",");
      }
      sb.append("]}");
      if (i < rs.size()-1) sb.append(",");
    }
    sb.append("]}");
    return sb.toString();
  }
  private static String toJsonValidateAll(java.util.List<FdmlValidator.Result> r1,
                                          java.util.List<SchematronValidator.Result> r2) {
    StringBuilder sb = new StringBuilder();
    sb.append("{\"command\":\"validate-all\",\"xsd\":");
    StringBuilder sb1 = new StringBuilder(); sb1.append("[");
    for (int i=0;i<r1.size();i++) {
      var r = r1.get(i);
      sb1.append("{\"file\":\"").append(esc(r.file.toString())).append("\",\"ok\":").append(r.ok);
      if (!r.ok) {
        if (r.message != null) sb1.append(",\"error\":\"").append(esc(r.message)).append("\"");
        if (r.line != null) sb1.append(",\"line\":").append(r.line);
        if (r.column != null) sb1.append(",\"column\":").append(r.column);
      }
      sb1.append("}");
      if (i < r1.size()-1) sb1.append(",");
    }
    sb1.append("]");
    sb.append(sb1).append(",\"schematron\":");
    StringBuilder sb2 = new StringBuilder(); sb2.append("[");
    for (int i=0;i<r2.size();i++) {
      var r = r2.get(i);
      sb2.append("{\"file\":\"").append(esc(r.file.toString())).append("\",\"ok\":").append(r.ok)
         .append(",\"failures\":").append(r.failures).append(",\"messages\":[");
      for (int j=0;j<r.messages.size();j++) {
        sb2.append("\"").append(esc(r.messages.get(j))).append("\"");
        if (j<r.messages.size()-1) sb2.append(",");
      }
      sb2.append("]}");
      if (i < r2.size()-1) sb2.append(",");
    }
    sb2.append("]");
    sb.append(sb2).append("}");
    return sb.toString();
  }
  private static String toJsonLint(java.util.List<Linter.FileResult> rs) {
    StringBuilder sb = new StringBuilder();
    sb.append("{\"command\":\"lint\",\"results\":[");
    for (int i=0;i<rs.size();i++) {
      var r = rs.get(i);
      sb.append("{\"file\":\"").append(esc(r.file.toString())).append("\",\"ok\":").append(r.ok()).append(",\"warnings\":[");
      for (int j=0;j<r.warnings.size();j++) {
        var w = r.warnings.get(j);
        sb.append("{\"code\":\"").append(esc(w.code)).append("\"");
        if (w.figureId != null) sb.append(",\"figure\":\"").append(esc(w.figureId)).append("\"");
        if (w.meter != null) sb.append(",\"meter\":\"").append(esc(w.meter)).append("\"");
        if (w.bars != null) sb.append(",\"bars\":\"").append(esc(w.bars)).append("\"");
        if (w.message != null) sb.append(",\"message\":\"").append(esc(w.message)).append("\"");
        sb.append(",\"beats\":").append(w.beats).append("}");
        if (j<r.warnings.size()-1) sb.append(",");
      }
      sb.append("]}");
      if (i<rs.size()-1) sb.append(",");
    }
    sb.append("]}");
    return sb.toString();
  }

  private static void usage() {
    System.out.println("FDML CLI");
    System.out.println("Usage:");
    System.out.println("  validate <path> [...] [--json] [--json-out file]");
    System.out.println("  validate-sch <path> [...] [--json] [--json-out file]");
    System.out.println("  validate-all <path> [...] [--json] [--json-out file]");
    System.out.println("  render <fdml-file> [--out out.html]");
    System.out.println("  export-pdf <fdml-file> [--out out.pdf]");
    System.out.println("  index  <path> [...] [--out out.json]");
    System.out.println("  lint   <path> [...] [--json] [--json-out file] [--strict]");
    System.out.println("  init   <output-file> [--title T] [--dance D] [--meter M/N] [--tempo BPM] [--figure-id f-...] [--figure-name NAME] [--formation FORM]");
    System.out.println("  doctor <path> [...] [--json] [--strict]");
  }
}

--- END src/main/java/org/fdml/cli/Main.java ---
--- BEGIN src/main/java/org/fdml/cli/MainJson.java ---
package org.fdml.cli;

class MainJson {
  static String esc(String s){ if(s==null)return null; return s.replace("\\","\\\\").replace("\"","\\\"").replace("\n","\\n").replace("\r",""); }

  static String toJsonDoctor(java.util.List<FdmlValidator.Result> rX,
                             java.util.List<SchematronValidator.Result> rS,
                             java.util.List<Linter.FileResult> rL){
    StringBuilder sb=new StringBuilder();
    sb.append("{\"command\":\"doctor\",\"xsd\":[");
    for(int i=0;i<rX.size();i++){ var r=rX.get(i);
      sb.append("{\"file\":\"").append(esc(r.file.toString())).append("\",\"ok\":").append(r.ok);
      if(!r.ok && r.message!=null) sb.append(",\"error\":\"").append(esc(r.message)).append("\"");
      sb.append("}"); if(i<rX.size()-1) sb.append(",");
    }
    sb.append("],\"schematron\":[");
    for(int i=0;i<rS.size();i++){ var r=rS.get(i);
      sb.append("{\"file\":\"").append(esc(r.file.toString())).append("\",\"ok\":").append(r.ok)
        .append(",\"failures\":").append(r.failures).append(",\"messages\":[");
      for(int j=0;j<r.messages.size();j++){ sb.append("\"").append(esc(r.messages.get(j))).append("\""); if(j<r.messages.size()-1) sb.append(","); }
      sb.append("]}"); if(i<rS.size()-1) sb.append(",");
    }
    sb.append("],\"lint\":[");
    for(int i=0;i<rL.size();i++){ var fr=rL.get(i);
      sb.append("{\"file\":\"").append(esc(fr.file.toString())).append("\",\"ok\":").append(fr.ok()).append(",\"warnings\":[");
      for(int j=0;j<fr.warnings.size();j++){ var w=fr.warnings.get(j);
        sb.append("{\"code\":\"").append(esc(w.code)).append("\",\"beats\":").append(w.beats);
        if(w.figureId!=null) sb.append(",\"figure\":\"").append(esc(w.figureId)).append("\"");
        if(w.meter!=null) sb.append(",\"meter\":\"").append(esc(w.meter)).append("\"");
        if(w.bars!=null) sb.append(",\"bars\":\"").append(esc(w.bars)).append("\"");
        if(w.message!=null) sb.append(",\"message\":\"").append(esc(w.message)).append("\"");
        sb.append("}"); if(j<fr.warnings.size()-1) sb.append(",");
      }
      sb.append("]}"); if(i<rL.size()-1) sb.append(",");
    }
    sb.append("]}");
    return sb.toString();
  }
}

--- END src/main/java/org/fdml/cli/MainJson.java ---
--- BEGIN src/main/java/org/fdml/cli/PdfExporter.java ---
package org.fdml.cli;

import com.openhtmltopdf.pdfboxout.PdfRendererBuilder;
import java.io.*;
import java.nio.file.*;

class PdfExporter {

  static void export(Path fdmlFile, Path xslFile, Path examplesDir, Path outPdf) {
    try {
      Files.createDirectories(outPdf.getParent());
      Files.createDirectories(examplesDir);

      Path tempHtml = examplesDir.resolve(".export-temp.html");
      Renderer.render(fdmlFile, xslFile, tempHtml);

      String html = Files.readString(tempHtml);
      String base = examplesDir.toUri().toString();

      try (OutputStream os = Files.newOutputStream(outPdf, StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING)) {
        PdfRendererBuilder b = new PdfRendererBuilder();
        b.useFastMode();
        b.withHtmlContent(html, base);
        b.toStream(os);
        b.run();
      }

      Files.deleteIfExists(tempHtml);
      System.out.println("PDF: " + outPdf);
    } catch (Exception e) {
      throw new RuntimeException("PDF export failed for " + fdmlFile + " → " + outPdf, e);
    }
  }
}

--- END src/main/java/org/fdml/cli/PdfExporter.java ---
--- BEGIN src/main/java/org/fdml/cli/Renderer.java ---
package org.fdml.cli;

import net.sf.saxon.s9api.*;
import javax.xml.transform.stream.StreamSource;
import java.io.File;
import java.nio.file.Path;

class Renderer {
  static void render(Path xmlPath, Path xslPath, Path outPath) {
    try {
      Processor proc = new Processor(false);
      XsltCompiler comp = proc.newXsltCompiler();
      XsltExecutable exec = comp.compile(new StreamSource(xslPath.toFile()));
      XsltTransformer t = exec.load();
      t.setSource(new StreamSource(xmlPath.toFile()));
      Serializer s = proc.newSerializer(new File(outPath.toString()));
      s.setOutputProperty(Serializer.Property.INDENT, "yes");
      t.setDestination(s);
      t.transform();
      System.out.println("Rendered: " + outPath);
    } catch (Exception e) {
      throw new RuntimeException("Render failed for " + xmlPath + " with " + xslPath, e);
    }
  }
}

--- END src/main/java/org/fdml/cli/Renderer.java ---
--- BEGIN src/main/java/org/fdml/cli/SchematronValidator.java ---
package org.fdml.cli;

import net.sf.saxon.s9api.*;
import javax.xml.transform.stream.StreamSource;
import java.nio.file.*;
import java.util.*;

class SchematronValidator {
  static class Result {
    final Path file;
    final boolean ok;
    final int failures;
    final List<String> messages;
    Result(Path file, boolean ok, int failures, List<String> messages) {
      this.file = file; this.ok = ok; this.failures = failures; this.messages = messages;
    }
  }

  private final Processor proc;
  private final XsltExecutable compiledSchematron;

  SchematronValidator(Path compiledSchematronXsl) {
    try {
      proc = new Processor(false);
      XsltCompiler comp = proc.newXsltCompiler();
      compiledSchematron = comp.compile(new StreamSource(compiledSchematronXsl.toFile()));
    } catch (SaxonApiException e) {
      throw new RuntimeException("Failed to load compiled Schematron: " + compiledSchematronXsl, e);
    }
  }

  List<Result> validateCollect(List<Path> inputs) {
    List<Path> files = expandAll(inputs);
    List<Result> out = new ArrayList<>();
    for (Path f : files) out.add(validateFile(f));
    return out;
  }

  boolean validatePaths(List<Path> inputs) {
    List<Result> results = validateCollect(inputs);
    boolean allOk = true;
    for (Result r : results) {
      if (r.ok) System.out.println("SCH OK  : " + r.file);
      else {
        System.out.println("SCH FAIL: " + r.file + " (" + r.failures + " failure(s))");
        if (!r.messages.isEmpty()) System.out.println("  \u2192 " + String.join(" | ", r.messages));
      }
      allOk &= r.ok;
    }
    System.out.printf("Schematron checked %d file(s).%n", results.size());
    return allOk;
  }

  private Result validateFile(Path xml) {
    try {
      XsltTransformer t = compiledSchematron.load();
      XdmDestination dest = new XdmDestination();
      t.setSource(new StreamSource(xml.toFile()));
      t.setDestination(dest);
      t.transform();

      XPathCompiler xpc = proc.newXPathCompiler();
      xpc.declareNamespace("svrl","http://purl.oclc.org/dsdl/svrl");

      XdmNode svrl = dest.getXdmNode();
      XdmValue failed = xpc.evaluate("//svrl:failed-assert", svrl);
      int count = failed.size();

      List<String> msgs = new ArrayList<>();
      XdmValue texts = xpc.evaluate("//svrl:failed-assert/svrl:text/string()", svrl);
      for (XdmItem i : texts) msgs.add(i.getStringValue());

      return new Result(xml, count == 0, count, msgs);
    } catch (Exception e) {
      return new Result(xml, false, 1, List.of("Schematron error: " + e.getMessage()));
    }
  }

  private List<Path> expandAll(List<Path> inputs) {
    List<Path> out = new ArrayList<>();
    for (Path p : inputs) {
      try {
        if (Files.isDirectory(p)) Files.walk(p).filter(Files::isRegularFile).forEach(out::add);
        else out.add(p);
      } catch (Exception e) { throw new RuntimeException(e); }
    }
    return out;
  }
}

--- END src/main/java/org/fdml/cli/SchematronValidator.java ---

## Tests and snapshots (paths + small files)
src/test/java/org/fdml/cli/RenderSnapshotTest.java
"--- BEGIN src/test/resources/snapshots/example-01.html ---"
sed: 1: ""1,160p"": invalid command code "
